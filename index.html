<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’° ç°¡å–®è²¡å‹™è¨˜è³¬ç³»çµ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--primary:#4f46e5;--primary-dark:#3730a3;--success:#10b981;--danger:#ef4444;--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;--gray-400:#9ca3af;--gray-500:#6b7280;--gray-600:#4b5563;--gray-700:#374151;--gray-800:#1f2937;--shadow:0 1px 3px rgba(0,0,0,.12);--shadow-lg:0 10px 15px -3px rgba(0,0,0,.1);--radius:12px;--radius-sm:8px}
body{font-family:'Noto Sans TC',-apple-system,sans-serif;background:var(--gray-100);color:var(--gray-800);min-height:100vh}
.auth-container{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea,#764ba2);padding:20px}
.auth-card{background:#fff;border-radius:20px;padding:40px;width:100%;max-width:440px;box-shadow:var(--shadow-lg)}
.auth-header{text-align:center;margin-bottom:30px}
.auth-icon{font-size:48px;color:var(--primary);margin-bottom:10px}
.auth-header h1{font-size:28px;margin-bottom:5px}
.auth-header p{color:var(--gray-500);font-size:14px}
.auth-form h2{font-size:20px;margin-bottom:20px;color:var(--gray-700)}
.form-group{margin-bottom:16px;flex:1}
.form-group label{display:block;font-size:13px;font-weight:500;color:var(--gray-600);margin-bottom:6px}
.form-group input,.form-group select{width:100%;padding:10px 14px;border:2px solid var(--gray-200);border-radius:var(--radius-sm);font-size:14px;font-family:inherit;background:#fff}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,.1)}
.form-row{display:flex;gap:16px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 20px;border:none;border-radius:var(--radius-sm);font-size:14px;font-weight:500;font-family:inherit;cursor:pointer;transition:all .2s}
.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-dark)}
.btn-success{background:var(--success);color:#fff}.btn-danger{background:var(--danger);color:#fff}
.btn-outline{background:transparent;color:var(--gray-600);border:2px solid var(--gray-300)}
.btn-google{background:#fff;color:var(--gray-700);border:2px solid var(--gray-300)}
.btn-full{width:100%}.btn-sm{padding:6px 12px;font-size:13px}.btn-xs{padding:4px 8px;font-size:12px}
.divider{text-align:center;margin:20px 0;position:relative}
.divider::before{content:'';position:absolute;top:50%;left:0;right:0;height:1px;background:var(--gray-200)}
.divider span{background:#fff;padding:0 12px;position:relative;color:var(--gray-400);font-size:13px}
.auth-switch{text-align:center;margin-top:20px;font-size:14px;color:var(--gray-500)}
.auth-switch a{color:var(--primary);text-decoration:none;font-weight:500;cursor:pointer}
.error-message{background:#fef2f2;color:var(--danger);padding:10px 14px;border-radius:var(--radius-sm);font-size:13px;margin-top:16px;border:1px solid #fecaca}
.app-container{min-height:100vh}
.app-header{background:#fff;padding:12px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow);position:sticky;top:0;z-index:100}
.header-left{display:flex;align-items:center;gap:10px}
.header-left i{font-size:24px;color:var(--primary)}
.header-left h1{font-size:20px}
.header-right{display:flex;align-items:center;gap:12px}
.user-info-block{text-align:right}
.user-name{font-size:14px;font-weight:600;color:var(--gray-800)}
.user-date{font-size:11px;color:var(--gray-400)}
.tab-nav{background:#fff;display:flex;overflow-x:auto;border-bottom:2px solid var(--gray-200);padding:0 16px}
.tab-btn{flex-shrink:0;display:flex;align-items:center;gap:6px;padding:14px 20px;border:none;background:none;font-size:14px;font-weight:500;font-family:inherit;color:var(--gray-500);cursor:pointer;border-bottom:3px solid transparent;margin-bottom:-2px}
.tab-btn.active{color:var(--primary);border-bottom-color:var(--primary)}
.main-content{max-width:960px;margin:0 auto;padding:20px}
.tab-content{display:none}.tab-content.active{display:block}
.card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.card-header{padding:16px 20px;border-bottom:1px solid var(--gray-100);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
.card-header h2{font-size:16px;display:flex;align-items:center;gap:8px}
.card-body{padding:20px}.mt-20{margin-top:20px}
.text-success{color:var(--success)}.text-danger{color:var(--danger)}
.records-list{max-height:500px;overflow-y:auto}
.record-item{display:flex;align-items:center;padding:12px 0;border-bottom:1px solid var(--gray-100);gap:12px}
.record-item:last-child{border-bottom:none}
.record-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.record-icon.expense{background:#fef2f2;color:var(--danger)}
.record-icon.income{background:#ecfdf5;color:var(--success)}
.record-info{flex:1;min-width:0}
.record-title{font-weight:500;font-size:14px}
.record-meta{font-size:12px;color:var(--gray-400);margin-top:2px}
.record-amount{font-weight:700;font-size:15px;flex-shrink:0}
.record-amount.expense{color:var(--danger)}.record-amount.income{color:var(--success)}
.record-actions{display:flex;gap:4px;flex-shrink:0}
.empty-msg{text-align:center;color:var(--gray-400);padding:30px;font-size:14px}
.filter-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.filter-row select,.filter-row input{padding:6px 10px;border:2px solid var(--gray-200);border-radius:var(--radius-sm);font-size:13px;font-family:inherit}
.summary-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.summary-card{background:#fff;border-radius:var(--radius);padding:20px;display:flex;align-items:center;gap:16px;box-shadow:var(--shadow)}
.summary-icon{width:50px;height:50px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}
.income-card .summary-icon{background:#ecfdf5;color:var(--success)}
.expense-card .summary-icon{background:#fef2f2;color:var(--danger)}
.net-card .summary-icon{background:#eef2ff;color:var(--primary)}
.summary-label{display:block;font-size:12px;color:var(--gray-500);margin-bottom:4px}
.summary-value{display:block;font-size:22px;font-weight:700}
.report-table-container{overflow-x:auto}
.report-table{width:100%;border-collapse:collapse;font-size:13px}
.report-table th{background:var(--gray-50);padding:10px 14px;text-align:left;font-weight:600;color:var(--gray-600);border-bottom:2px solid var(--gray-200);white-space:nowrap}
.report-table td{padding:10px 14px;border-bottom:1px solid var(--gray-100)}
.report-table .total-row td{font-weight:700;background:var(--gray-50);border-top:2px solid var(--gray-300)}
.settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px}
.add-item-row{display:flex;gap:8px;margin-bottom:16px}
.add-item-row input{flex:1;padding:8px 12px;border:2px solid var(--gray-200);border-radius:var(--radius-sm);font-size:13px;font-family:inherit}
.tags-list{display:flex;flex-wrap:wrap;gap:8px}
.tag-item{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:var(--gray-100);border-radius:20px;font-size:13px}
.tag-item .tag-delete{cursor:pointer;color:var(--gray-400);font-size:12px}
.toast-container{position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 20px;border-radius:var(--radius-sm);font-size:14px;color:#fff;box-shadow:var(--shadow-lg);animation:toastIn .3s ease,toastOut .3s ease 2.7s forwards;max-width:350px}
.toast.success{background:var(--success)}.toast.error{background:var(--danger)}.toast.info{background:var(--primary)}
@keyframes toastIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes toastOut{from{opacity:1}to{opacity:0}}
.modal{position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center}
.modal-overlay{position:absolute;inset:0;background:rgba(0,0,0,.5)}
.modal-content{position:relative;background:#fff;border-radius:var(--radius);width:90%;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--gray-200)}
.modal-header h3{font-size:16px}
.btn-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--gray-400);line-height:1}
.modal-body{padding:20px}
.modal-footer{padding:12px 20px;border-top:1px solid var(--gray-200);display:flex;justify-content:flex-end;gap:8px}
.loading-spinner{display:inline-block;width:20px;height:20px;border:2px solid var(--gray-200);border-top-color:var(--primary);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.converted-amount{font-size:13px;color:var(--primary);font-weight:600;padding:8px 12px;background:#eef2ff;border-radius:var(--radius-sm);margin-top:4px;display:none}
.currency-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;padding:8px;background:var(--gray-50);border-radius:var(--radius-sm)}
.currency-row .curr-name{flex:1;font-weight:500;font-size:14px}
.currency-row .curr-rate{width:100px;font-size:13px}
.currency-row input{width:100px;padding:4px 8px;border:1px solid var(--gray-300);border-radius:4px;font-size:13px}
@media(max-width:768px){.form-row{flex-direction:column}.summary-cards{grid-template-columns:1fr}.settings-grid{grid-template-columns:1fr}.user-info-block{display:none}}
</style>
</head>
<body>

<!-- ç™»å…¥é é¢ -->
<div id="auth-container" class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <i class="fas fa-wallet auth-icon"></i>
            <h1>ç°¡å–®è²¡å‹™è¨˜è³¬</h1>
            <p>è¼•é¬†ç®¡ç†ä½ çš„æ”¶å…¥èˆ‡æ”¯å‡º</p>
        </div>
        <div id="login-form" class="auth-form">
            <h2>ç™»å…¥</h2>
            <div class="form-group"><label><i class="fas fa-envelope"></i> é›»å­éƒµä»¶</label><input type="email" id="login-email" placeholder="your@email.com"></div>
            <div class="form-group"><label><i class="fas fa-lock"></i> å¯†ç¢¼</label><input type="password" id="login-password" placeholder="è¼¸å…¥å¯†ç¢¼"></div>
            <button class="btn btn-primary btn-full" onclick="loginWithEmail()"><i class="fas fa-sign-in-alt"></i> ç™»å…¥</button>
            <div class="divider"><span>æˆ–</span></div>
            <button class="btn btn-google btn-full" onclick="loginWithGoogle()"><i class="fab fa-google"></i> ä½¿ç”¨ Google ç™»å…¥</button>
            <p class="auth-switch">é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ<a onclick="showRegister()">ç«‹å³è¨»å†Š</a></p>
        </div>
        <div id="register-form" class="auth-form" style="display:none;">
            <h2>è¨»å†Š</h2>
            <div class="form-group"><label><i class="fas fa-user"></i> åç¨± *</label><input type="text" id="register-name" placeholder="ä½ çš„åç¨±"></div>
            <div class="form-group"><label><i class="fas fa-envelope"></i> é›»å­éƒµä»¶</label><input type="email" id="register-email" placeholder="your@email.com"></div>
            <div class="form-group"><label><i class="fas fa-lock"></i> å¯†ç¢¼ï¼ˆè‡³å°‘6ä½ï¼‰</label><input type="password" id="register-password" placeholder="è¨­å®šå¯†ç¢¼"></div>
            <div class="form-group"><label><i class="fas fa-lock"></i> ç¢ºèªå¯†ç¢¼</label><input type="password" id="register-password-confirm" placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼"></div>
            <button class="btn btn-primary btn-full" onclick="registerWithEmail()"><i class="fas fa-user-plus"></i> è¨»å†Š</button>
            <div class="divider"><span>æˆ–</span></div>
            <button class="btn btn-google btn-full" onclick="loginWithGoogle()"><i class="fab fa-google"></i> ä½¿ç”¨ Google è¨»å†Š</button>
            <p class="auth-switch">å·²æœ‰å¸³è™Ÿï¼Ÿ<a onclick="showLogin()">è¿”å›ç™»å…¥</a></p>
        </div>
        <div id="auth-error" class="error-message" style="display:none;"></div>
    </div>
</div>

<!-- Google ç™»å…¥åç¨±è£œå¡« Modal -->
<div id="name-modal" class="modal" style="display:none;">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header"><h3>ğŸ‘‹ æ­¡è¿ï¼è«‹è¼¸å…¥ä½ çš„åç¨±</h3></div>
        <div class="modal-body">
            <div class="form-group"><label>åç¨± *</label><input type="text" id="google-name-input" placeholder="ä½ çš„åç¨±"></div>
        </div>
        <div class="modal-footer"><button class="btn btn-primary" onclick="saveGoogleName()">ç¢ºèª</button></div>
    </div>
</div>

<!-- ä¸»æ‡‰ç”¨ -->
<div id="app-container" class="app-container" style="display:none;">
    <header class="app-header">
        <div class="header-left"><i class="fas fa-wallet"></i><h1>è²¡å‹™è¨˜è³¬</h1></div>
        <div class="header-right">
            <div class="user-info-block">
                <div class="user-name" id="user-display-name">ä½¿ç”¨è€…</div>
                <div class="user-date" id="user-display-date"></div>
            </div>
            <button class="btn btn-sm btn-outline" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ç™»å‡º</button>
        </div>
    </header>
    <nav class="tab-nav">
        <button class="tab-btn active" data-tab="expense" onclick="switchTab('expense')"><i class="fas fa-arrow-down text-danger"></i> æ”¯å‡º</button>
        <button class="tab-btn" data-tab="income" onclick="switchTab('income')"><i class="fas fa-arrow-up text-success"></i> æ”¶å…¥</button>
        <button class="tab-btn" data-tab="records" onclick="switchTab('records')"><i class="fas fa-list"></i> è¨˜éŒ„</button>
        <button class="tab-btn" data-tab="reports" onclick="switchTab('reports')"><i class="fas fa-chart-bar"></i> å ±è¡¨</button>
        <button class="tab-btn" data-tab="settings" onclick="switchTab('settings')"><i class="fas fa-cog"></i> è¨­å®š</button>
    </nav>
    <main class="main-content">
        <!-- æ”¯å‡º -->
        <div id="tab-expense" class="tab-content active">
            <div class="card">
                <div class="card-header"><h2><i class="fas fa-minus-circle text-danger"></i> æ–°å¢æ”¯å‡º</h2></div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group"><label>é‡‘é¡ *</label><input type="number" id="expense-amount" placeholder="0.00" step="0.01" min="0" oninput="convertCurrency('expense')"></div>
                        <div class="form-group"><label>è²¨å¹£</label><select id="expense-currency" onchange="convertCurrency('expense')"></select></div>
                        <div class="form-group"><label>æ—¥æœŸ *</label><input type="date" id="expense-date"></div>
                    </div>
                    <div id="expense-converted" class="converted-amount"></div>
                    <div class="form-row">
                        <div class="form-group"><label>å½¢å¼ *</label><select id="expense-method"><option value="ç¾é‡‘">ğŸ’µ ç¾é‡‘</option><option value="éŠ€è¡Œ">ğŸ¦ éŠ€è¡Œ</option><option value="ä¿¡ç”¨å¡">ğŸ’³ ä¿¡ç”¨å¡</option></select></div>
                        <div class="form-group"><label>ç¨®é¡ *</label><select id="expense-category"><option value="">-- é¸æ“‡ --</option></select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Project</label><select id="expense-project"><option value="">-- ç„¡ --</option></select></div>
                        <div class="form-group"><label>å‚™è¨»</label><input type="text" id="expense-note" placeholder="é¸å¡«"></div>
                    </div>
                    <button class="btn btn-danger btn-full" onclick="addExpense()"><i class="fas fa-plus"></i> æ–°å¢æ”¯å‡º</button>
                </div>
            </div>
            <div class="card mt-20"><div class="card-header"><h2><i class="fas fa-history"></i> æœ€è¿‘æ”¯å‡º</h2></div><div class="card-body"><div id="recent-expenses" class="records-list"><p class="empty-msg">è¼‰å…¥ä¸­...</p></div></div></div>
        </div>
        <!-- æ”¶å…¥ -->
        <div id="tab-income" class="tab-content">
            <div class="card">
                <div class="card-header"><h2><i class="fas fa-plus-circle text-success"></i> æ–°å¢æ”¶å…¥</h2></div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group"><label>é‡‘é¡ *</label><input type="number" id="income-amount" placeholder="0.00" step="0.01" min="0" oninput="convertCurrency('income')"></div>
                        <div class="form-group"><label>è²¨å¹£</label><select id="income-currency" onchange="convertCurrency('income')"></select></div>
                        <div class="form-group"><label>æ—¥æœŸ *</label><input type="date" id="income-date"></div>
                    </div>
                    <div id="income-converted" class="converted-amount"></div>
                    <div class="form-row">
                        <div class="form-group"><label>å½¢å¼ *</label><select id="income-method"><option value="ç¾é‡‘">ğŸ’µ ç¾é‡‘</option><option value="éŠ€è¡Œ">ğŸ¦ éŠ€è¡Œ</option></select></div>
                        <div class="form-group"><label>ç¨®é¡ *</label><select id="income-category"><option value="">-- é¸æ“‡ --</option></select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Project</label><select id="income-project"><option value="">-- ç„¡ --</option></select></div>
                        <div class="form-group"><label>å‚™è¨»</label><input type="text" id="income-note" placeholder="é¸å¡«"></div>
                    </div>
                    <button class="btn btn-success btn-full" onclick="addIncome()"><i class="fas fa-plus"></i> æ–°å¢æ”¶å…¥</button>
                </div>
            </div>
            <div class="card mt-20"><div class="card-header"><h2><i class="fas fa-history"></i> æœ€è¿‘æ”¶å…¥</h2></div><div class="card-body"><div id="recent-incomes" class="records-list"><p class="empty-msg">è¼‰å…¥ä¸­...</p></div></div></div>
        </div>
        <!-- è¨˜éŒ„ -->
        <div id="tab-records" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-list-alt"></i> æ‰€æœ‰è¨˜éŒ„</h2>
                    <div class="filter-row"><select id="records-filter-type" onchange="loadAllRecords()"><option value="all">å…¨éƒ¨</option><option value="expense">æ”¯å‡º</option><option value="income">æ”¶å…¥</option></select><input type="date" id="records-filter-start" onchange="loadAllRecords()"><span>ï½</span><input type="date" id="records-filter-end" onchange="loadAllRecords()"></div>
                </div>
                <div class="card-body"><div id="all-records" class="records-list"><p class="empty-msg">è¼‰å…¥ä¸­...</p></div></div>
            </div>
        </div>
        <!-- å ±è¡¨ -->
        <div id="tab-reports" class="tab-content">
            <div class="card">
                <div class="card-header"><h2><i class="fas fa-chart-pie"></i> è²¡å‹™å ±è¡¨</h2></div>
                <div class="card-body"><div class="form-row"><div class="form-group"><label>é–‹å§‹æ—¥æœŸ</label><input type="date" id="report-start"></div><div class="form-group"><label>çµæŸæ—¥æœŸ</label><input type="date" id="report-end"></div><div class="form-group" style="display:flex;align-items:flex-end"><button class="btn btn-primary" onclick="generateReports()"><i class="fas fa-search"></i> ç”Ÿæˆ</button></div></div></div>
            </div>
            <div class="summary-cards mt-20" id="report-summary" style="display:none;">
                <div class="summary-card income-card"><div class="summary-icon"><i class="fas fa-arrow-up"></i></div><div class="summary-info"><span class="summary-label">ç¸½æ”¶å…¥</span><span class="summary-value" id="report-total-income">0</span></div></div>
                <div class="summary-card expense-card"><div class="summary-icon"><i class="fas fa-arrow-down"></i></div><div class="summary-info"><span class="summary-label">ç¸½æ”¯å‡º</span><span class="summary-value" id="report-total-expense">0</span></div></div>
                <div class="summary-card net-card"><div class="summary-icon"><i class="fas fa-balance-scale"></i></div><div class="summary-info"><span class="summary-label">æ·¨é¡</span><span class="summary-value" id="report-net">0</span></div></div>
            </div>
            <div class="card mt-20" id="report-income-section" style="display:none;"><div class="card-header"><h2><i class="fas fa-arrow-up text-success"></i> æ”¶å…¥å ±è¡¨</h2></div><div class="card-body"><div id="report-income-detail" class="report-table-container"></div></div></div>
            <div class="card mt-20" id="report-expense-section" style="display:none;"><div class="card-header"><h2><i class="fas fa-arrow-down text-danger"></i> æ”¯å‡ºå ±è¡¨</h2></div><div class="card-body"><div id="report-expense-detail" class="report-table-container"></div></div></div>
            <div class="card mt-20" id="report-all-section" style="display:none;"><div class="card-header"><h2><i class="fas fa-exchange-alt"></i> æ”¶æ”¯ç¸½è¡¨</h2></div><div class="card-body"><div id="report-all-detail" class="report-table-container"></div></div></div>
        </div>
        <!-- è¨­å®š -->
        <div id="tab-settings" class="tab-content">
            <div class="settings-grid">
                <!-- Base Currency -->
                <div class="card">
                    <div class="card-header"><h2><i class="fas fa-coins"></i> åŸºç¤è²¨å¹£</h2></div>
                    <div class="card-body">
                        <div class="form-group"><label>Base Currency</label>
                            <select id="settings-base-currency" onchange="saveBaseCurrency()">
                                <option value="GBP">ğŸ‡¬ğŸ‡§ GBP</option><option value="USD">ğŸ‡ºğŸ‡¸ USD</option><option value="EUR">ğŸ‡ªğŸ‡º EUR</option>
                                <option value="HKD">ğŸ‡­ğŸ‡° HKD</option><option value="CNY">ğŸ‡¨ğŸ‡³ CNY</option><option value="JPY">ğŸ‡¯ğŸ‡µ JPY</option>
                                <option value="TWD">ğŸ‡¹ğŸ‡¼ TWD</option><option value="SGD">ğŸ‡¸ğŸ‡¬ SGD</option><option value="AUD">ğŸ‡¦ğŸ‡º AUD</option>
                                <option value="CAD">ğŸ‡¨ğŸ‡¦ CAD</option><option value="CHF">ğŸ‡¨ğŸ‡­ CHF</option><option value="MYR">ğŸ‡²ğŸ‡¾ MYR</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- Currency Rates -->
                <div class="card">
                    <div class="card-header"><h2><i class="fas fa-exchange-alt"></i> è²¨å¹£åŒ¯ç‡</h2></div>
                    <div class="card-body">
                        <p style="font-size:12px;color:var(--gray-500);margin-bottom:12px">1 <span id="base-currency-label">GBP</span> = ?</p>
                        <div class="add-item-row">
                            <select id="new-currency-code" style="width:100px;padding:8px;border:2px solid var(--gray-200);border-radius:var(--radius-sm);font-size:13px">
                                <option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option>
                                <option value="HKD">HKD</option><option value="CNY">CNY</option><option value="JPY">JPY</option>
                                <option value="TWD">TWD</option><option value="SGD">SGD</option><option value="AUD">AUD</option>
                                <option value="CAD">CAD</option><option value="CHF">CHF</option><option value="MYR">MYR</option>
                            </select>
                            <input type="number" id="new-currency-rate" placeholder="åŒ¯ç‡" step="0.0001" min="0" style="width:100px">
                            <button class="btn btn-sm btn-primary" onclick="addCurrencyRate()"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="currency-rates-list"></div>
                    </div>
                </div>
                <!-- æ”¯å‡ºç¨®é¡ -->
                <div class="card"><div class="card-header"><h2><i class="fas fa-tags text-danger"></i> æ”¯å‡ºç¨®é¡</h2></div><div class="card-body"><div class="add-item-row"><input type="text" id="new-expense-category" placeholder="æ–°å¢" onkeypress="if(event.key==='Enter')addCategory('expense')"><button class="btn btn-sm btn-primary" onclick="addCategory('expense')"><i class="fas fa-plus"></i></button></div><div id="expense-categories-list" class="tags-list"></div></div></div>
                <!-- æ”¶å…¥ç¨®é¡ -->
                <div class="card"><div class="card-header"><h2><i class="fas fa-tags text-success"></i> æ”¶å…¥ç¨®é¡</h2></div><div class="card-body"><div class="add-item-row"><input type="text" id="new-income-category" placeholder="æ–°å¢" onkeypress="if(event.key==='Enter')addCategory('income')"><button class="btn btn-sm btn-primary" onclick="addCategory('income')"><i class="fas fa-plus"></i></button></div><div id="income-categories-list" class="tags-list"></div></div></div>
                <!-- Projects -->
                <div class="card"><div class="card-header"><h2><i class="fas fa-project-diagram"></i> Projects</h2></div><div class="card-body"><div class="add-item-row"><input type="text" id="new-project" placeholder="æ–°å¢" onkeypress="if(event.key==='Enter')addProject()"><button class="btn btn-sm btn-primary" onclick="addProject()"><i class="fas fa-plus"></i></button></div><div id="projects-list" class="tags-list"></div></div></div>
            </div>
        </div>
    </main>
</div>

<div id="toast-container" class="toast-container"></div>
<div id="edit-modal" class="modal" style="display:none;">
    <div class="modal-overlay" onclick="closeEditModal()"></div>
    <div class="modal-content">
        <div class="modal-header"><h3 id="edit-modal-title">ç·¨è¼¯</h3><button class="btn-close" onclick="closeEditModal()">&times;</button></div>
        <div class="modal-body" id="edit-modal-body"></div>
        <div class="modal-footer"><button class="btn btn-outline" onclick="closeEditModal()">å–æ¶ˆ</button><button class="btn btn-primary" id="edit-modal-save">å„²å­˜</button></div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// âš ï¸ å¡«å…¥ä½ çš„ Firebase è¨­å®š
var firebaseConfig = {
    apiKey: "AIzaSyAcZrnL8Aze4ZIlh6RgornQ0oBd6xa092M",
    authDomain: "simple-books-700d7.firebaseapp.com",
    projectId: "simple-books-700d7",
    storageBucket: "simple-books-700d7.firebasestorage.app",
    messagingSenderId: "1066770660576",
    appId: "1:1066770660576:web:08637e911bb3852fbaa485",
    measurementId: "G-NRS5F5X9ZS"
};
firebase.initializeApp(firebaseConfig);
var auth = firebase.auth();
var db = firebase.firestore();
var googleProvider = new firebase.auth.GoogleAuthProvider();

// ===== å…¨å±€è®Šé‡ =====
var currentUserId = null;
var userName = '';
var baseCurrency = 'GBP';
var currencyRates = {};
var expenseCategories = [];
var incomeCategories = [];
var projects = [];
var DEF_EXP = ['é¤é£²','äº¤é€š','ä½æˆ¿','è³¼ç‰©','å¨›æ¨‚','é†«ç™‚','æ•™è‚²','å…¶ä»–'];
var DEF_INC = ['è–ªè³‡','æŠ•è³‡','å…¼è·','çé‡‘','å…¶ä»–'];

// ===== èªè­‰ =====
function showLogin() {
    document.getElementById('login-form').style.display = 'block';
    document.getElementById('register-form').style.display = 'none';
    document.getElementById('auth-error').style.display = 'none';
}
function showRegister() {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('register-form').style.display = 'block';
    document.getElementById('auth-error').style.display = 'none';
}
function showAuthError(msg) {
    document.getElementById('auth-error').textContent = msg;
    document.getElementById('auth-error').style.display = 'block';
}

function loginWithEmail() {
    var email = document.getElementById('login-email').value.trim();
    var password = document.getElementById('login-password').value;
    if (!email || !password) { showAuthError('è«‹å¡«å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼'); return; }
    auth.signInWithEmailAndPassword(email, password).catch(function(e) { showAuthError(getAuthErr(e.code)); });
}

function registerWithEmail() {
    var name = document.getElementById('register-name').value.trim();
    var email = document.getElementById('register-email').value.trim();
    var pw = document.getElementById('register-password').value;
    var pw2 = document.getElementById('register-password-confirm').value;
    if (!name) { showAuthError('è«‹è¼¸å…¥åç¨±'); return; }
    if (!email || !pw) { showAuthError('è«‹å¡«å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼'); return; }
    if (pw !== pw2) { showAuthError('å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´'); return; }
    if (pw.length < 6) { showAuthError('å¯†ç¢¼è‡³å°‘éœ€è¦6å€‹å­—å…ƒ'); return; }
    auth.createUserWithEmailAndPassword(email, pw).then(function(cred) {
        return cred.user.updateProfile({ displayName: name });
    }).then(function() {
        return db.collection('users').doc(auth.currentUser.uid).collection('settings').doc('profile').set({ name: name });
    }).catch(function(e) { showAuthError(getAuthErr(e.code)); });
}

function loginWithGoogle() {
    auth.signInWithPopup(googleProvider).catch(function(e) {
        if (e.code !== 'auth/popup-closed-by-user') showAuthError(getAuthErr(e.code));
    });
}

function logout() { auth.signOut(); }

function getAuthErr(c) {
    var m = {'auth/user-not-found':'æ­¤é›»å­éƒµä»¶å°šæœªè¨»å†Š','auth/wrong-password':'å¯†ç¢¼éŒ¯èª¤','auth/email-already-in-use':'æ­¤é›»å­éƒµä»¶å·²è¢«è¨»å†Š','auth/weak-password':'å¯†ç¢¼è‡³å°‘éœ€è¦6å€‹å­—å…ƒ','auth/invalid-email':'é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢º','auth/too-many-requests':'å˜—è©¦æ¬¡æ•¸éå¤š','auth/invalid-credential':'é›»å­éƒµä»¶æˆ–å¯†ç¢¼éŒ¯èª¤'};
    return m[c] || 'ç™¼ç”ŸéŒ¯èª¤ (' + c + ')';
}

function saveGoogleName() {
    var name = document.getElementById('google-name-input').value.trim();
    if (!name) { showToast('è«‹è¼¸å…¥åç¨±', 'error'); return; }
    auth.currentUser.updateProfile({ displayName: name }).then(function() {
        return db.collection('users').doc(currentUserId).collection('settings').doc('profile').set({ name: name });
    }).then(function() {
        userName = name;
        document.getElementById('user-display-name').textContent = name;
        document.getElementById('name-modal').style.display = 'none';
        showToast('åç¨±å·²è¨­å®š', 'success');
    });
}

auth.onAuthStateChanged(function(user) {
    if (user) {
        currentUserId = user.uid;
        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        // é¡¯ç¤ºæ—¥æœŸ
        var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        var now = new Date();
        document.getElementById('user-display-date').textContent = now.getDate() + ' ' + months[now.getMonth()] + ' ' + now.getFullYear();
        // è¼‰å…¥åç¨±
        db.collection('users').doc(user.uid).collection('settings').doc('profile').get().then(function(doc) {
            if (doc.exists && doc.data().name) {
                userName = doc.data().name;
                document.getElementById('user-display-name').textContent = userName;
            } else if (user.displayName) {
                userName = user.displayName;
                document.getElementById('user-display-name').textContent = userName;
                db.collection('users').doc(user.uid).collection('settings').doc('profile').set({ name: userName });
            } else {
                document.getElementById('name-modal').style.display = 'flex';
            }
        });
        initializeApp(user.uid);
    } else {
        document.getElementById('auth-container').style.display = 'flex';
        document.getElementById('app-container').style.display = 'none';
    }
});

// ===== åˆå§‹åŒ– =====
function initializeApp(uid) {
    var today = new Date().toISOString().split('T')[0];
    document.getElementById('expense-date').value = today;
    document.getElementById('income-date').value = today;
    var now = new Date();
    var fd = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    var ld = new Date(now.getFullYear(), now.getMonth()+1, 0).toISOString().split('T')[0];
    document.getElementById('report-start').value = fd;
    document.getElementById('report-end').value = ld;
    document.getElementById('records-filter-start').value = fd;
    document.getElementById('records-filter-end').value = ld;
    loadBaseCurrency();
    loadCurrencyRates();
    loadCategories();
    loadProjects();
    loadRecentExpenses();
    loadRecentIncomes();
}

function showToast(msg, type) {
    type = type || 'info';
    var c = document.getElementById('toast-container');
    var t = document.createElement('div');
    t.className = 'toast ' + type; t.textContent = msg; c.appendChild(t);
    setTimeout(function() { t.remove(); }, 3000);
}

function switchTab(name) {
    document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.tab === name); });
    document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.toggle('active', c.id === 'tab-' + name); });
    if (name === 'records') loadAllRecords();
}

// ===== è²¨å¹£ =====
function loadBaseCurrency() {
    db.collection('users').doc(currentUserId).collection('settings').doc('currency').get().then(function(doc) {
        if (doc.exists && doc.data().base) {
            baseCurrency = doc.data().base;
        }
        document.getElementById('settings-base-currency').value = baseCurrency;
        document.getElementById('base-currency-label').textContent = baseCurrency;
        updateCurrencyDropdowns();
    });
}

function saveBaseCurrency() {
    baseCurrency = document.getElementById('settings-base-currency').value;
    document.getElementById('base-currency-label').textContent = baseCurrency;
    db.collection('users').doc(currentUserId).collection('settings').doc('currency').set({ base: baseCurrency }, { merge: true });
    updateCurrencyDropdowns();
    showToast('åŸºç¤è²¨å¹£å·²è¨­ç‚º ' + baseCurrency, 'success');
}

function loadCurrencyRates() {
    db.collection('users').doc(currentUserId).collection('settings').doc('currencyRates').get().then(function(doc) {
        if (doc.exists) { currencyRates = doc.data().rates || {}; }
        renderCurrencyRates();
        updateCurrencyDropdowns();
    });
}

function saveCurrencyRates() {
    db.collection('users').doc(currentUserId).collection('settings').doc('currencyRates').set({ rates: currencyRates });
}

function addCurrencyRate() {
    var code = document.getElementById('new-currency-code').value;
    var rate = parseFloat(document.getElementById('new-currency-rate').value);
    if (!rate || rate <= 0) { showToast('è«‹è¼¸å…¥æœ‰æ•ˆåŒ¯ç‡', 'error'); return; }
    currencyRates[code] = rate;
    saveCurrencyRates();
    renderCurrencyRates();
    updateCurrencyDropdowns();
    document.getElementById('new-currency-rate').value = '';
    showToast('å·²è¨­å®š ' + baseCurrency + ' 1 = ' + code + ' ' + rate, 'success');
}

function removeCurrencyRate(code) {
    delete currencyRates[code];
    saveCurrencyRates();
    renderCurrencyRates();
    updateCurrencyDropdowns();
}

function renderCurrencyRates() {
    var html = '';
    Object.keys(currencyRates).forEach(function(code) {
        html += '<div class="currency-row"><span class="curr-name">' + baseCurrency + ' 1 = ' + code + ' ' + currencyRates[code] + '</span><button class="btn btn-xs btn-outline" onclick="removeCurrencyRate(\'' + code + '\')"><i class="fas fa-trash"></i></button></div>';
    });
    document.getElementById('currency-rates-list').innerHTML = html || '<p style="color:var(--gray-400);font-size:13px">å°šæœªè¨­å®šåŒ¯ç‡</p>';
}

function updateCurrencyDropdowns() {
    var options = '<option value="' + baseCurrency + '">' + baseCurrency + ' (åŸºç¤)</option>';
    Object.keys(currencyRates).forEach(function(code) {
        options += '<option value="' + code + '">' + code + '</option>';
    });
    document.getElementById('expense-currency').innerHTML = options;
    document.getElementById('income-currency').innerHTML = options;
}

function convertToBase(amount, currency) {
    if (currency === baseCurrency) return amount;
    var rate = currencyRates[currency];
    if (!rate) return amount;
    return amount / rate;
}

function convertCurrency(type) {
    var amount = parseFloat(document.getElementById(type + '-amount').value);
    var currency = document.getElementById(type + '-currency').value;
    var el = document.getElementById(type + '-converted');
    if (!amount || amount <= 0 || currency === baseCurrency) {
        el.style.display = 'none';
        return;
    }
    var baseAmt = convertToBase(amount, currency);
    el.textContent = 'â‰ˆ ' + baseCurrency + ' ' + baseAmt.toFixed(2);
    el.style.display = 'block';
}

// ===== åˆ†é¡ =====
function loadCategories() {
    db.collection('users').doc(currentUserId).collection('settings').doc('expenseCategories').get().then(function(doc) {
        if (doc.exists) { expenseCategories = doc.data().list || []; } else { expenseCategories = DEF_EXP.slice(); saveCats('expense'); }
        updateCatDD(); renderCatTags();
    });
    db.collection('users').doc(currentUserId).collection('settings').doc('incomeCategories').get().then(function(doc) {
        if (doc.exists) { incomeCategories = doc.data().list || []; } else { incomeCategories = DEF_INC.slice(); saveCats('income'); }
        updateCatDD(); renderCatTags();
    });
}
function saveCats(type) {
    var name = type === 'expense' ? 'expenseCategories' : 'incomeCategories';
    var list = type === 'expense' ? expenseCategories : incomeCategories;
    db.collection('users').doc(currentUserId).collection('settings').doc(name).set({ list: list });
}
function updateCatDD() {
    var h = '<option value="">-- é¸æ“‡ --</option>';
    expenseCategories.forEach(function(c) { h += '<option value="' + c + '">' + c + '</option>'; });
    document.getElementById('expense-category').innerHTML = h;
    h = '<option value="">-- é¸æ“‡ --</option>';
    incomeCategories.forEach(function(c) { h += '<option value="' + c + '">' + c + '</option>'; });
    document.getElementById('income-category').innerHTML = h;
}
function renderCatTags() {
    var h = '';
    expenseCategories.forEach(function(c) { h += '<span class="tag-item">' + c + ' <i class="fas fa-times tag-delete" onclick="removeCat(\'expense\',\'' + c + '\')"></i></span>'; });
    document.getElementById('expense-categories-list').innerHTML = h;
    h = '';
    incomeCategories.forEach(function(c) { h += '<span class="tag-item">' + c + ' <i class="fas fa-times tag-delete" onclick="removeCat(\'income\',\'' + c + '\')"></i></span>'; });
    document.getElementById('income-categories-list').innerHTML = h;
}
function addCategory(type) {
    var id = type === 'expense' ? 'new-expense-category' : 'new-income-category';
    var inp = document.getElementById(id); var n = inp.value.trim(); if (!n) return;
    var list = type === 'expense' ? expenseCategories : incomeCategories;
    if (list.indexOf(n) !== -1) { showToast('å·²å­˜åœ¨', 'error'); return; }
    list.push(n); saveCats(type); updateCatDD(); renderCatTags(); inp.value = '';
    showToast('å·²æ–°å¢: ' + n, 'success');
}
function removeCat(type, n) {
    if (!confirm('ç¢ºå®šåˆªé™¤ã€Œ' + n + 'ã€ï¼Ÿ')) return;
    if (type === 'expense') { expenseCategories = expenseCategories.filter(function(c){return c!==n;}); }
    else { incomeCategories = incomeCategories.filter(function(c){return c!==n;}); }
    saveCats(type); updateCatDD(); renderCatTags(); showToast('å·²åˆªé™¤: ' + n, 'info');
}

// ===== Project =====
function loadProjects() {
    db.collection('users').doc(currentUserId).collection('settings').doc('projects').get().then(function(doc) {
        projects = doc.exists ? (doc.data().list || []) : [];
        updateProjDD(); renderProjTags();
    });
}
function saveProjects() { db.collection('users').doc(currentUserId).collection('settings').doc('projects').set({ list: projects }); }
function updateProjDD() {
    var h = '<option value="">-- ç„¡ --</option>';
    projects.forEach(function(p) { h += '<option value="' + p + '">' + p + '</option>'; });
    document.getElementById('expense-project').innerHTML = h;
    document.getElementById('income-project').innerHTML = h;
}
function renderProjTags() {
    var h = '';
    projects.forEach(function(p) { h += '<span class="tag-item">' + p + ' <i class="fas fa-times tag-delete" onclick="removeProject(\'' + p + '\')"></i></span>'; });
    document.getElementById('projects-list').innerHTML = h;
}
function addProject() {
    var inp = document.getElementById('new-project'); var n = inp.value.trim(); if (!n) return;
    if (projects.indexOf(n) !== -1) { showToast('å·²å­˜åœ¨', 'error'); return; }
    projects.push(n); saveProjects(); updateProjDD(); renderProjTags(); inp.value = '';
    showToast('å·²æ–°å¢: ' + n, 'success');
}
function removeProject(n) {
    if (!confirm('ç¢ºå®šåˆªé™¤ã€Œ' + n + 'ã€ï¼Ÿ')) return;
    projects = projects.filter(function(p){return p!==n;});
    saveProjects(); updateProjDD(); renderProjTags(); showToast('å·²åˆªé™¤: ' + n, 'info');
}
</script>

<script>
// ===== æ–°å¢æ”¯å‡º =====
function addExpense() {
    var a = parseFloat(document.getElementById('expense-amount').value);
    var cur = document.getElementById('expense-currency').value;
    var d = document.getElementById('expense-date').value;
    var m = document.getElementById('expense-method').value;
    var c = document.getElementById('expense-category').value;
    var p = document.getElementById('expense-project').value;
    var n = document.getElementById('expense-note').value.trim();
    if (!a || a <= 0) { showToast('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡', 'error'); return; }
    if (!d) { showToast('è«‹é¸æ“‡æ—¥æœŸ', 'error'); return; }
    if (!c) { showToast('è«‹é¸æ“‡ç¨®é¡', 'error'); return; }
    var baseAmount = convertToBase(a, cur);
    db.collection('users').doc(currentUserId).collection('expenses').add({
        amount: baseAmount, originalAmount: a, currency: cur,
        date: d, method: m, category: c, project: p, note: n,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(function() {
        document.getElementById('expense-amount').value = '';
        document.getElementById('expense-note').value = '';
        document.getElementById('expense-converted').style.display = 'none';
        showToast('å·²è¨˜éŒ„æ”¯å‡º ' + baseCurrency + ' ' + baseAmount.toFixed(2), 'success');
        loadRecentExpenses();
    }).catch(function(e) { console.error(e); showToast('æ–°å¢å¤±æ•—', 'error'); });
}

// ===== æ–°å¢æ”¶å…¥ =====
function addIncome() {
    var a = parseFloat(document.getElementById('income-amount').value);
    var cur = document.getElementById('income-currency').value;
    var d = document.getElementById('income-date').value;
    var m = document.getElementById('income-method').value;
    var c = document.getElementById('income-category').value;
    var p = document.getElementById('income-project').value;
    var n = document.getElementById('income-note').value.trim();
    if (!a || a <= 0) { showToast('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡', 'error'); return; }
    if (!d) { showToast('è«‹é¸æ“‡æ—¥æœŸ', 'error'); return; }
    if (!c) { showToast('è«‹é¸æ“‡ç¨®é¡', 'error'); return; }
    var baseAmount = convertToBase(a, cur);
    db.collection('users').doc(currentUserId).collection('incomes').add({
        amount: baseAmount, originalAmount: a, currency: cur,
        date: d, method: m, category: c, project: p, note: n,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(function() {
        document.getElementById('income-amount').value = '';
        document.getElementById('income-note').value = '';
        document.getElementById('income-converted').style.display = 'none';
        showToast('å·²è¨˜éŒ„æ”¶å…¥ ' + baseCurrency + ' ' + baseAmount.toFixed(2), 'success');
        loadRecentIncomes();
    }).catch(function(e) { console.error(e); showToast('æ–°å¢å¤±æ•—', 'error'); });
}

// ===== è¼‰å…¥è¨˜éŒ„ =====
function loadRecentExpenses() {
    var ct = document.getElementById('recent-expenses');
    ct.innerHTML = '<p class="empty-msg"><span class="loading-spinner"></span> è¼‰å…¥ä¸­...</p>';
    db.collection('users').doc(currentUserId).collection('expenses').orderBy('date', 'desc').limit(10).get().then(function(snap) {
        if (snap.empty) { ct.innerHTML = '<p class="empty-msg">å°šç„¡æ”¯å‡ºè¨˜éŒ„</p>'; return; }
        ct.innerHTML = '';
        snap.forEach(function(doc) { ct.innerHTML += createRecordHTML(doc.id, doc.data(), 'expense'); });
    }).catch(function() { ct.innerHTML = '<p class="empty-msg">è¼‰å…¥å¤±æ•—</p>'; });
}

function loadRecentIncomes() {
    var ct = document.getElementById('recent-incomes');
    ct.innerHTML = '<p class="empty-msg"><span class="loading-spinner"></span> è¼‰å…¥ä¸­...</p>';
    db.collection('users').doc(currentUserId).collection('incomes').orderBy('date', 'desc').limit(10).get().then(function(snap) {
        if (snap.empty) { ct.innerHTML = '<p class="empty-msg">å°šç„¡æ”¶å…¥è¨˜éŒ„</p>'; return; }
        ct.innerHTML = '';
        snap.forEach(function(doc) { ct.innerHTML += createRecordHTML(doc.id, doc.data(), 'income'); });
    }).catch(function() { ct.innerHTML = '<p class="empty-msg">è¼‰å…¥å¤±æ•—</p>'; });
}

function loadAllRecords() {
    var ct = document.getElementById('all-records');
    ct.innerHTML = '<p class="empty-msg"><span class="loading-spinner"></span> è¼‰å…¥ä¸­...</p>';
    var ft = document.getElementById('records-filter-type').value;
    var sd = document.getElementById('records-filter-start').value;
    var ed = document.getElementById('records-filter-end').value;
    var all = [];
    var p1 = Promise.resolve();
    var p2 = Promise.resolve();
    if (ft === 'all' || ft === 'expense') {
        var q = db.collection('users').doc(currentUserId).collection('expenses').orderBy('date', 'desc');
        if (sd) q = q.where('date', '>=', sd); if (ed) q = q.where('date', '<=', ed);
        p1 = q.get().then(function(snap) { snap.forEach(function(doc) { all.push({id:doc.id,type:'expense',d:doc.data()}); }); });
    }
    if (ft === 'all' || ft === 'income') {
        var q2 = db.collection('users').doc(currentUserId).collection('incomes').orderBy('date', 'desc');
        if (sd) q2 = q2.where('date', '>=', sd); if (ed) q2 = q2.where('date', '<=', ed);
        p2 = q2.get().then(function(snap) { snap.forEach(function(doc) { all.push({id:doc.id,type:'income',d:doc.data()}); }); });
    }
    Promise.all([p1, p2]).then(function() {
        all.sort(function(a, b) { return b.d.date.localeCompare(a.d.date); });
        if (!all.length) { ct.innerHTML = '<p class="empty-msg">æ­¤æœŸé–“ç„¡è¨˜éŒ„</p>'; return; }
        ct.innerHTML = '';
        all.forEach(function(r) { ct.innerHTML += createRecordHTML(r.id, r.d, r.type); });
    }).catch(function() { ct.innerHTML = '<p class="empty-msg">è¼‰å…¥å¤±æ•—</p>'; });
}

function createRecordHTML(id, data, type) {
    var icon = type === 'expense' ? 'fa-arrow-down' : 'fa-arrow-up';
    var sign = type === 'expense' ? '-' : '+';
    var me = data.method === 'ç¾é‡‘' ? 'ğŸ’µ' : data.method === 'éŠ€è¡Œ' ? 'ğŸ¦' : 'ğŸ’³';
    var amt = (typeof data.amount === 'number') ? data.amount.toFixed(2) : '0.00';
    var origInfo = '';
    if (data.currency && data.currency !== baseCurrency && data.originalAmount) {
        origInfo = ' (' + data.currency + ' ' + data.originalAmount.toFixed(2) + ')';
    }
    return '<div class="record-item">' +
        '<div class="record-icon ' + type + '"><i class="fas ' + icon + '"></i></div>' +
        '<div class="record-info"><div class="record-title">' + data.category + (data.project ? ' Â· ' + data.project : '') + '</div>' +
        '<div class="record-meta">' + data.date + ' Â· ' + me + ' ' + data.method + (data.note ? ' Â· ' + data.note : '') + '</div></div>' +
        '<div class="record-amount ' + type