<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’° ç°¡å–®è²¡å‹™è¨˜è³¬ç³»çµ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* ============ Reset & Base ============ */
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    --primary: #4f46e5;
    --primary-light: #818cf8;
    --primary-dark: #3730a3;
    --success: #10b981;
    --success-light: #34d399;
    --danger: #ef4444;
    --danger-light: #f87171;
    --warning: #f59e0b;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.06);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    --radius: 12px;
    --radius-sm: 8px;
}

body {
    font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--gray-100);
    color: var(--gray-800);
    min-height: 100vh;
}

/* ============ Auth Page ============ */
.auth-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px;
}

.auth-card {
    background: white;
    border-radius: 20px;
    padding: 40px;
    width: 100%;
    max-width: 440px;
    box-shadow: var(--shadow-lg);
}

.auth-header {
    text-align: center;
    margin-bottom: 30px;
}

.auth-icon {
    font-size: 48px;
    color: var(--primary);
    margin-bottom: 10px;
}

.auth-header h1 {
    font-size: 28px;
    color: var(--gray-800);
    margin-bottom: 5px;
}

.auth-header p {
    color: var(--gray-500);
    font-size: 14px;
}

.auth-form h2 {
    font-size: 20px;
    margin-bottom: 20px;
    color: var(--gray-700);
}

.form-group {
    margin-bottom: 16px;
    flex: 1;
}

.form-group label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: var(--gray-600);
    margin-bottom: 6px;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-family: inherit;
    transition: border-color 0.2s, box-shadow 0.2s;
    background: white;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.form-row {
    display: flex;
    gap: 16px;
}

.flex-end {
    display: flex;
    align-items: flex-end;
}

/* ============ Buttons ============ */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 20px;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-weight: 500;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s;
}

.btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
.btn:active { transform: translateY(0); }
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-success { background: var(--success); color: white; }
.btn-success:hover { background: #059669; }
.btn-danger { background: var(--danger); color: white; }
.btn-danger:hover { background: #dc2626; }
.btn-outline { background: transparent; color: var(--gray-600); border: 2px solid var(--gray-300); }
.btn-outline:hover { border-color: var(--gray-400); background: var(--gray-50); }
.btn-google { background: white; color: var(--gray-700); border: 2px solid var(--gray-300); }
.btn-google:hover { background: var(--gray-50); border-color: var(--gray-400); }
.btn-full { width: 100%; }
.btn-sm { padding: 6px 12px; font-size: 13px; }
.btn-xs { padding: 4px 8px; font-size: 12px; }

/* ============ Divider ============ */
.divider { text-align: center; margin: 20px 0; position: relative; }
.divider::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: var(--gray-200); }
.divider span { background: white; padding: 0 12px; position: relative; color: var(--gray-400); font-size: 13px; }

.auth-switch { text-align: center; margin-top: 20px; font-size: 14px; color: var(--gray-500); }
.auth-switch a { color: var(--primary); text-decoration: none; font-weight: 500; }

.error-message {
    background: #fef2f2; color: var(--danger); padding: 10px 14px;
    border-radius: var(--radius-sm); font-size: 13px; margin-top: 16px; border: 1px solid #fecaca;
}

/* ============ App Layout ============ */
.app-container { min-height: 100vh; }

.app-header {
    background: white; padding: 12px 24px; display: flex;
    align-items: center; justify-content: space-between;
    box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100;
}

.header-left { display: flex; align-items: center; gap: 10px; }
.header-left i { font-size: 24px; color: var(--primary); }
.header-left h1 { font-size: 20px; color: var(--gray-800); }
.header-right { display: flex; align-items: center; gap: 12px; }
.user-info { font-size: 13px; color: var(--gray-500); }

/* ============ Tab Navigation ============ */
.tab-nav {
    background: white; display: flex; overflow-x: auto;
    border-bottom: 2px solid var(--gray-200); padding: 0 16px;
    -webkit-overflow-scrolling: touch;
}

.tab-btn {
    flex-shrink: 0; display: flex; align-items: center; gap: 6px;
    padding: 14px 20px; border: none; background: none; font-size: 14px;
    font-weight: 500; font-family: inherit; color: var(--gray-500);
    cursor: pointer; border-bottom: 3px solid transparent;
    transition: all 0.2s; margin-bottom: -2px;
}

.tab-btn:hover { color: var(--primary); }
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

/* ============ Main Content ============ */
.main-content { max-width: 960px; margin: 0 auto; padding: 20px; }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* ============ Cards ============ */
.card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
.card-header {
    padding: 16px 20px; border-bottom: 1px solid var(--gray-100);
    display: flex; align-items: center; justify-content: space-between;
    flex-wrap: wrap; gap: 10px;
}
.card-header h2 { font-size: 16px; display: flex; align-items: center; gap: 8px; }
.card-body { padding: 20px; }
.mt-20 { margin-top: 20px; }

.text-success { color: var(--success); }
.text-danger { color: var(--danger); }

/* ============ Records List ============ */
.records-list { max-height: 500px; overflow-y: auto; }

.record-item {
    display: flex; align-items: center; padding: 12px 0;
    border-bottom: 1px solid var(--gray-100); gap: 12px;
}
.record-item:last-child { border-bottom: none; }

.record-icon {
    width: 40px; height: 40px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; flex-shrink: 0;
}
.record-icon.expense { background: #fef2f2; color: var(--danger); }
.record-icon.income { background: #ecfdf5; color: var(--success); }

.record-info { flex: 1; min-width: 0; }
.record-info .record-title { font-weight: 500; font-size: 14px; color: var(--gray-800); }
.record-info .record-meta { font-size: 12px; color: var(--gray-400); margin-top: 2px; }

.record-amount { font-weight: 700; font-size: 15px; flex-shrink: 0; }
.record-amount.expense { color: var(--danger); }
.record-amount.income { color: var(--success); }

.record-actions { display: flex; gap: 4px; flex-shrink: 0; }
.record-actions .btn-xs { opacity: 0.6; }
.record-actions .btn-xs:hover { opacity: 1; }

.empty-msg { text-align: center; color: var(--gray-400); padding: 30px; font-size: 14px; }

/* ============ Filter Row ============ */
.filter-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.filter-row select, .filter-row input {
    padding: 6px 10px; border: 2px solid var(--gray-200);
    border-radius: var(--radius-sm); font-size: 13px; font-family: inherit;
}
.filter-row span { color: var(--gray-400); font-size: 13px; }

/* ============ Summary Cards ============ */
.summary-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }

.summary-card {
    background: white; border-radius: var(--radius); padding: 20px;
    display: flex; align-items: center; gap: 16px; box-shadow: var(--shadow);
}

.summary-icon {
    width: 50px; height: 50px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center; font-size: 20px;
}
.income-card .summary-icon { background: #ecfdf5; color: var(--success); }
.expense-card .summary-icon { background: #fef2f2; color: var(--danger); }
.net-card .summary-icon { background: #eef2ff; color: var(--primary); }

.summary-label { display: block; font-size: 12px; color: var(--gray-500); margin-bottom: 4px; }
.summary-value { display: block; font-size: 22px; font-weight: 700; color: var(--gray-800); }

/* ============ Report Tables ============ */
.report-table-container { overflow-x: auto; }
.report-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.report-table th {
    background: var(--gray-50); padding: 10px 14px; text-align: left;
    font-weight: 600; color: var(--gray-600); border-bottom: 2px solid var(--gray-200);
    white-space: nowrap;
}
.report-table td { padding: 10px 14px; border-bottom: 1px solid var(--gray-100); color: var(--gray-700); }
.report-table tr:hover td { background: var(--gray-50); }
.report-table .total-row td {
    font-weight: 700; background: var(--gray-50); border-top: 2px solid var(--gray-300);
}

/* ============ Settings ============ */
.settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
.add-item-row { display: flex; gap: 8px; margin-bottom: 16px; }
.add-item-row input {
    flex: 1; padding: 8px 12px; border: 2px solid var(--gray-200);
    border-radius: var(--radius-sm); font-size: 13px; font-family: inherit;
}
.add-item-row input:focus { outline: none; border-color: var(--primary); }

.tags-list { display: flex; flex-wrap: wrap; gap: 8px; }
.tag-item {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 6px 12px; background: var(--gray-100);
    border-radius: 20px; font-size: 13px; color: var(--gray-700);
}
.tag-item .tag-delete { cursor: pointer; color: var(--gray-400); font-size: 12px; transition: color 0.2s; }
.tag-item .tag-delete:hover { color: var(--danger); }

/* ============ Toast ============ */
.toast-container {
    position: fixed; top: 20px; right: 20px; z-index: 9999;
    display: flex; flex-direction: column; gap: 8px;
}
.toast {
    padding: 12px 20px; border-radius: var(--radius-sm); font-size: 14px;
    color: white; box-shadow: var(--shadow-lg);
    animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
    max-width: 350px;
}
.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
.toast.info { background: var(--primary); }

@keyframes toastIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes toastOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }

/* ============ Modal ============ */
.modal {
    position: fixed; inset: 0; z-index: 1000;
    display: flex; align-items: center; justify-content: center;
}
.modal-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); }
.modal-content {
    position: relative; background: white; border-radius: var(--radius);
    width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
    box-shadow: var(--shadow-lg);
}
.modal-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px; border-bottom: 1px solid var(--gray-200);
}
.modal-header h3 { font-size: 16px; }
.btn-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-400); line-height: 1; }
.btn-close:hover { color: var(--gray-600); }
.modal-body { padding: 20px; }
.modal-footer {
    padding: 12px 20px; border-top: 1px solid var(--gray-200);
    display: flex; justify-content: flex-end; gap: 8px;
}

/* ============ Loading ============ */
.loading-spinner {
    display: inline-block; width: 20px; height: 20px;
    border: 2px solid var(--gray-200); border-top-color: var(--primary);
    border-radius: 50%; animation: spin 0.6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ============ Responsive ============ */
@media (max-width: 768px) {
    .form-row { flex-direction: column; gap: 0; }
    .summary-cards { grid-template-columns: 1fr; }
    .app-header { padding: 10px 16px; }
    .header-left h1 { font-size: 16px; }
    .user-info { display: none; }
    .main-content { padding: 12px; }
    .tab-btn { padding: 12px 14px; font-size: 13px; }
    .card-header { flex-direction: column; align-items: flex-start; }
    .filter-row { width: 100%; }
    .auth-card { padding: 24px; }
    .settings-grid { grid-template-columns: 1fr; }
}

::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--gray-400); }
</style>
</head>
<body>

<!-- ============ ç™»å…¥é é¢ ============ -->
<div id="auth-container" class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <i class="fas fa-wallet auth-icon"></i>
            <h1>ç°¡å–®è²¡å‹™è¨˜è³¬</h1>
            <p>è¼•é¬†ç®¡ç†ä½ çš„æ”¶å…¥èˆ‡æ”¯å‡º</p>
        </div>

        <div id="login-form" class="auth-form">
            <h2>ç™»å…¥</h2>
            <div class="form-group">
                <label><i class="fas fa-envelope"></i> é›»å­éƒµä»¶</label>
                <input type="email" id="login-email" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label><i class="fas fa-lock"></i> å¯†ç¢¼</label>
                <input type="password" id="login-password" placeholder="è¼¸å…¥å¯†ç¢¼">
            </div>
            <button class="btn btn-primary btn-full" onclick="loginWithEmail()">
                <i class="fas fa-sign-in-alt"></i> ç™»å…¥
            </button>
            <div class="divider"><span>æˆ–</span></div>
            <button class="btn btn-google btn-full" onclick="loginWithGoogle()">
                <i class="fab fa-google"></i> ä½¿ç”¨ Google ç™»å…¥
            </button>
            <p class="auth-switch">é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ<a href="#" onclick="showRegister()">ç«‹å³è¨»å†Š</a></p>
        </div>

        <div id="register-form" class="auth-form" style="display:none;">
            <h2>è¨»å†Š</h2>
            <div class="form-group">
                <label><i class="fas fa-envelope"></i> é›»å­éƒµä»¶</label>
                <input type="email" id="register-email" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label><i class="fas fa-lock"></i> å¯†ç¢¼ï¼ˆè‡³å°‘6ä½ï¼‰</label>
                <input type="password" id="register-password" placeholder="è¨­å®šå¯†ç¢¼">
            </div>
            <div class="form-group">
                <label><i class="fas fa-lock"></i> ç¢ºèªå¯†ç¢¼</label>
                <input type="password" id="register-password-confirm" placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼">
            </div>
            <button class="btn btn-primary btn-full" onclick="registerWithEmail()">
                <i class="fas fa-user-plus"></i> è¨»å†Š
            </button>
            <div class="divider"><span>æˆ–</span></div>
            <button class="btn btn-google btn-full" onclick="loginWithGoogle()">
                <i class="fab fa-google"></i> ä½¿ç”¨ Google è¨»å†Š
            </button>
            <p class="auth-switch">å·²æœ‰å¸³è™Ÿï¼Ÿ<a href="#" onclick="showLogin()">è¿”å›ç™»å…¥</a></p>
        </div>

        <div id="auth-error" class="error-message" style="display:none;"></div>
    </div>
</div>

<!-- ============ ä¸»æ‡‰ç”¨ç¨‹å¼ ============ -->
<div id="app-container" class="app-container" style="display:none;">
    
    <header class="app-header">
        <div class="header-left">
            <i class="fas fa-wallet"></i>
            <h1>è²¡å‹™è¨˜è³¬</h1>
        </div>
        <div class="header-right">
            <span id="user-display" class="user-info"></span>
            <button class="btn btn-sm btn-outline" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> ç™»å‡º
            </button>
        </div>
    </header>

    <nav class="tab-nav">
        <button class="tab-btn active" data-tab="expense" onclick="switchTab('expense')">
            <i class="fas fa-arrow-down text-danger"></i> è¨˜éŒ„æ”¯å‡º
        </button>
        <button class="tab-btn" data-tab="income" onclick="switchTab('income')">
            <i class="fas fa-arrow-up text-success"></i> è¨˜éŒ„æ”¶å…¥
        </button>
        <button class="tab-btn" data-tab="records" onclick="switchTab('records')">
            <i class="fas fa-list"></i> æ‰€æœ‰è¨˜éŒ„
        </button>
        <button class="tab-btn" data-tab="reports" onclick="switchTab('reports')">
            <i class="fas fa-chart-bar"></i> å ±è¡¨
        </button>
        <button class="tab-btn" data-tab="settings" onclick="switchTab('settings')">
            <i class="fas fa-cog"></i> è¨­å®š
        </button>
    </nav>

    <main class="main-content">

        <!-- ====== æ”¯å‡ºé é¢ ====== -->
        <div id="tab-expense" class="tab-content active">
            <div class="card">
                <div class="card-header"><h2><i class="fas fa-minus-circle text-danger"></i> æ–°å¢æ”¯å‡º</h2></div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>é‡‘é¡ *</label>
                            <input type="number" id="expense-amount" placeholder="0.00" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label>æ—¥æœŸ *</label>
                            <input type="date" id="expense-date">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ”¯å‡ºå½¢å¼ *</label>
                            <select id="expense-method">
                                <option value="ç¾é‡‘">ğŸ’µ ç¾é‡‘</option>
                                <option value="éŠ€è¡Œ">ğŸ¦ éŠ€è¡Œ</option>
                                <option value="ä¿¡ç”¨å¡">ğŸ’³ ä¿¡ç”¨å¡</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è²»ç”¨ç¨®é¡ *</label>
                            <select id="expense-category"><option value="">-- é¸æ“‡ç¨®é¡ --</option></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Project</label>
                            <select id="expense-project"><option value="">-- é¸æ“‡ Project --</option></select>
                        </div>
                        <div class="form-group">
                            <label>å‚™è¨»</label>
                            <input type="text" id="expense-note" placeholder="é¸å¡«å‚™è¨»">
                        </div>
                    </div>
                    <button class="btn btn-danger btn-full" onclick="addExpense()">
                        <i class="fas fa-plus"></i> æ–°å¢æ”¯å‡º
                    </button>
                </div>
            </div>
            <div class="card mt-20">
                <div class="card-header"><h2><i class="fas fa-history"></i> æœ€è¿‘æ”¯å‡º</h2></div>
                <div class="card-body">
                    <div id="recent-expenses" class="records-list"><p class="empty-msg">è¼‰å…¥ä¸­...</p></div>
                </div>
            </div>
        </div>

        <!-- ====== æ”¶å…¥é é¢ ====== -->
        <div id="tab-income" class="tab-content">
            <div class="card">
                <div class="card-header"><h2><i class="fas fa-plus-circle text-success"></i> æ–°å¢æ”¶å…¥</h2></div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>é‡‘é¡ *</label>
                            <input type="number" id="income-amount" placeholder="0.00" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label>æ—¥æœŸ *</label>
                            <input type="date" id="income-date">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ”¶å…¥å½¢å¼ *</label>
                            <select id="income-method">
                                <option value="ç¾é‡‘">ğŸ’µ ç¾é‡‘</option>
                                <option value="éŠ€è¡Œ">ğŸ¦ éŠ€è¡Œ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æ”¶å…¥ç¨®é¡ *</label>
                            <select id="income-category"><option value="">-- é¸æ“‡ç¨®é¡ --</option></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Project</label>
                            <select id="income-project"><option value="">-- é¸æ“‡ Project --</option></select>
                        </div>
                        <div class="form-group">
                            <label>å‚™è¨»</label>
                            <input type="text" id="income-note" placeholder="é¸å¡«å‚™è¨»">
                        </div>
                    </div>
                    <button class="btn btn-success btn-full" onclick="addIncome()">
                        <i class="fas fa-plus"></i> æ–°å¢æ”¶å…¥
                    </button>
                </div>
            </div>
            <div class="card mt-20">
                <div class="card-header"><h2><i class="fas fa-history"></i> æœ€è¿‘æ”¶å…¥</h2></div>
                <div class="card-body">
                    <div id="recent-incomes" class="records-list"><p class="empty-msg">è¼‰å…¥ä¸­...</p></div>
                </div>
            </div>
        </div>

        <!-- ====== æ‰€æœ‰è¨˜éŒ„é é¢ ====== -->
        <div id="tab-records" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-list-alt"></i> æ‰€æœ‰è¨˜éŒ„</h2>
                    <div class="filter-row">
                        <select id="records-filter-type" onchange="loadAllRecords()">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="expense">åƒ…æ”¯å‡º</option>
                            <option value="income">åƒ…æ”¶å…¥</option>
                        </select>
                        <input type="date" id="records-filter-start" onchange="loadAllRecords()">
                        <span>ï½</span>
                        <input type="date" id="records-filter-end" onchange="loadAllRecords()">
                    </div>
                </div>
                <div class="card-body">
                    <div id="all-records" class="records-list"><p class="empty-msg">è¼‰å…¥ä¸­...</p></div>
                </div>
            </div>
        </div>

        <!-- ====== å ±è¡¨é é¢ ====== -->
        <div id="tab-reports" class="tab-content">
            <div class="card">
                <div class="card-header"><h2><i class="fas fa-chart-pie"></i> è²¡å‹™å ±è¡¨</h2></div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>é–‹å§‹æ—¥æœŸ</label>
                            <input type="date" id="report-start">
                        </div>
                        <div class="form-group">
                            <label>çµæŸæ—¥æœŸ</label>
                            <input type="date" id="report-end">
                        </div>
                        <div class="form-group flex-end">
                            <button class="btn btn-primary" onclick="generateReports()">
                                <i class="fas fa-search"></i> ç”Ÿæˆå ±è¡¨
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="summary-cards mt-20" id="report-summary" style="display:none;">
                <div class="summary-card income-card">
                    <div class="summary-icon"><i class="fas fa-arrow-up"></i></div>
                    <div class="summary-info">
                        <span class="summary-label">ç¸½æ”¶å…¥</span>
                        <span class="summary-value" id="report-total-income">\$0</span>
                    </div>
                </div>
                <div class="summary-card expense-card">
                    <div class="summary-icon"><i class="fas fa-arrow-down"></i></div>
                    <div class="summary-info">
                        <span class="summary-label">ç¸½æ”¯å‡º</span>
                        <span class="summary-value" id="report-total-expense">\$0</span>
                    </div>
                </div>
                <div class="summary-card net-card">
                    <div class="summary-icon"><i class="fas fa-balance-scale"></i></div>
                    <div class="summary-info">
                        <span class="summary-label">æ·¨æ”¶æ”¯</span>
                        <span class="summary-value" id="report-net">\$0</span>
                    </div>
                </div>
            </div>

            <div class="card mt-20" id="report-income-section" style="display:none;">
                <div class="card-header"><h2><i class="fas fa-arrow-up text-success"></i> æ·¨æ”¶å…¥å ±è¡¨</h2></div>
                <div class="card-body"><div id="report-income-detail" class="report-table-container"></div></div>
            </div>

            <div class="card mt-20" id="report-expense-section" style="display:none;">
                <div class="card-header"><h2><i class="fas fa-arrow-down text-danger"></i> æ·¨æ”¯å‡ºå ±è¡¨</h2></div>
                <div class="card-body"><div id="report-expense-detail" class="report-table-container"></div></div>
            </div>

            <div class="card mt-20" id="report-all-section" style="display:none;">
                <div class="card-header"><h2><i class="fas fa-exchange-alt"></i> æ”¶å…¥èˆ‡æ”¯å‡ºç¸½è¡¨</h2></div>
                <div class="card-body"><div id="report-all-detail" class="report-table-container"></div></div>
            </div>
        </div>

        <!-- ====== è¨­å®šé é¢ ====== -->
        <div id="tab-settings" class="tab-content">
            <div class="settings-grid">
                <div class="card">
                    <div class="card-header"><h2><i class="fas fa-tags text-danger"></i> æ”¯å‡ºç¨®é¡</h2></div>
                    <div class="card-body">
                        <div class="add-item-row">
                            <input type="text" id="new-expense-category" placeholder="æ–°å¢æ”¯å‡ºç¨®é¡" onkeypress="if(event.key==='Enter')addCategory('expense')">
                            <button class="btn btn-sm btn-primary" onclick="addCategory('expense')"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="expense-categories-list" class="tags-list"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h2><i class="fas fa-tags text-success"></i> æ”¶å…¥ç¨®é¡</h2></div>
                    <div class="card-body">
                        <div class="add-item-row">
                            <input type="text" id="new-income-category" placeholder="æ–°å¢æ”¶å…¥ç¨®é¡" onkeypress="if(event.key==='Enter')addCategory('income')">
                            <button class="btn btn-sm btn-primary" onclick="addCategory('income')"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="income-categories-list" class="tags-list"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h2><i class="fas fa-project-diagram"></i> Projects</h2></div>
                    <div class="card-body">
                        <div class="add-item-row">
                            <input type="text" id="new-project" placeholder="æ–°å¢ Project" onkeypress="if(event.key==='Enter')addProject()">
                            <button class="btn btn-sm btn-primary" onclick="addProject()"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="projects-list" class="tags-list"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>
</div>

<!-- Toast -->
<div id="toast-container" class="toast-container"></div>

<!-- Modal -->
<div id="edit-modal" class="modal" style="display:none;">
    <div class="modal-overlay" onclick="closeEditModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="edit-modal-title">ç·¨è¼¯è¨˜éŒ„</h3>
            <button class="btn-close" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="modal-body" id="edit-modal-body"></div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeEditModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="edit-modal-save">å„²å­˜</button>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// ============================================================
// âš ï¸âš ï¸âš ï¸ ç¬¬ä¸€æ­¥ï¼šè«‹å°‡ä¸‹æ–¹è¨­å®šæ›¿æ›æˆä½ è‡ªå·±çš„ Firebase è¨­å®š âš ï¸âš ï¸âš ï¸
// å–å¾—æ–¹å¼ï¼šFirebase Console > å°ˆæ¡ˆè¨­å®š > ä½ çš„æ‡‰ç”¨ç¨‹å¼ > Web
// ============================================================
const firebaseConfig = {
    apiKey: "AIzaSyAcZrnL8Aze4ZIlh6RgornQ0oBd6xa092M",
    authDomain: "simple-books-700d7.firebaseapp.com",
    projectId: "simple-books-700d7",
    storageBucket: "simple-books-700d7.firebasestorage.app",
    messagingSenderId: "1066770660576",
    appId: "1:1066770660576:web:08637e911bb3852fbaa485",
    measurementId: "G-NRS5F5X9ZS"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const googleProvider = new firebase.auth.GoogleAuthProvider();

// ============================================================
// èªè­‰æ¨¡çµ„
// ============================================================
function showLogin() {
    document.getElementById('login-form').style.display = 'block';
    document.getElementById('register-form').style.display = 'none';
    document.getElementById('auth-error').style.display = 'none';
}

function showRegister() {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('register-form').style.display = 'block';
    document.getElementById('auth-error').style.display = 'none';
}

function showAuthError(msg) {
    const el = document.getElementById('auth-error');
    el.textContent = msg;
    el.style.display = 'block';
}

async function loginWithEmail() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    if (!email || !password) { showAuthError('è«‹å¡«å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼'); return; }
    try { await auth.signInWithEmailAndPassword(email, password); }
    catch (e) { showAuthError(getAuthErrorMessage(e.code)); }
}

async function registerWithEmail() {
    const email = document.getElementById('register-email').value.trim();
    const pw = document.getElementById('register-password').value;
    const pw2 = document.getElementById('register-password-confirm').value;
    if (!email || !pw) { showAuthError('è«‹å¡«å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼'); return; }
    if (pw !== pw2) { showAuthError('å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´'); return; }
    if (pw.length < 6) { showAuthError('å¯†ç¢¼è‡³å°‘éœ€è¦6å€‹å­—å…ƒ'); return; }
    try { await auth.createUserWithEmailAndPassword(email, pw); }
    catch (e) { showAuthError(getAuthErrorMessage(e.code)); }
}

async function loginWithGoogle() {
    try { await auth.signInWithPopup(googleProvider); }
    catch (e) { if (e.code !== 'auth/popup-closed-by-user') showAuthError(getAuthErrorMessage(e.code)); }
}

async function logout() {
    try { await auth.signOut(); }
    catch (e) { showToast('ç™»å‡ºå¤±æ•—', 'error'); }
}

auth.onAuthStateChanged(async (user) => {
    if (user) {
        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        document.getElementById('user-display').textContent = user.email || user.displayName || 'ä½¿ç”¨è€…';
        await initializeApp(user.uid);
    } else {
        document.getElementById('auth-container').style.display = 'flex';
        document.getElementById('app-container').style.display = 'none';
    }
});

function getAuthErrorMessage(code) {
    const m = {
        'auth/user-not-found': 'æ­¤é›»å­éƒµä»¶å°šæœªè¨»å†Š',
        'auth/wrong-password': 'å¯†ç¢¼éŒ¯èª¤',
        'auth/email-already-in-use': 'æ­¤é›»å­éƒµä»¶å·²è¢«è¨»å†Š',
        'auth/weak-password': 'å¯†ç¢¼å¤ªå¼±ï¼Œè‡³å°‘éœ€è¦6å€‹å­—å…ƒ',
        'auth/invalid-email': 'é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢º',
        'auth/too-many-requests': 'å˜—è©¦æ¬¡æ•¸éå¤šï¼Œè«‹ç¨å¾Œå†è©¦',
        'auth/network-request-failed': 'ç¶²è·¯é€£ç·šå¤±æ•—',
        'auth/popup-blocked': 'å½ˆå‡ºè¦–çª—è¢«å°é–ï¼Œè«‹å…è¨±æ­¤ç¶²ç«™çš„å½ˆå‡ºè¦–çª—',
        'auth/invalid-credential': 'é›»å­éƒµä»¶æˆ–å¯†ç¢¼éŒ¯èª¤'
    };
    return m[code] || 'ç™¼ç”ŸéŒ¯èª¤ (' + code + ')';
}

// ç™»å…¥é é¢ Enter éµæ”¯æŒ
document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        if (document.getElementById('login-form').style.display !== 'none' &&
            document.getElementById('auth-container').style.display !== 'none') {
            loginWithEmail();
        }
    }
});

// ============================================================
// ä¸»æ‡‰ç”¨æ¨¡çµ„
// ============================================================
let currentUserId = null;
let expenseCategories = [];
let incomeCategories = [];
let projects = [];

const DEFAULT_EXPENSE_CATEGORIES = ['é¤é£²', 'äº¤é€š', 'ä½æˆ¿', 'è³¼ç‰©', 'å¨›æ¨‚', 'é†«ç™‚', 'æ•™è‚²', 'å…¶ä»–'];
const DEFAULT_INCOME_CATEGORIES = ['è–ªè³‡', 'æŠ•è³‡', 'å…¼è·', 'çé‡‘', 'å…¶ä»–'];

async function initializeApp(uid) {
    currentUserId = uid;
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('expense-date').value = today;
    document.getElementById('income-date').value = today;

    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
    document.getElementById('report-start').value = firstDay;
    document.getElementById('report-end').value = lastDay;
    document.getElementById('records-filter-start').value = firstDay;
    document.getElementById('records-filter-end').value = lastDay;

    await loadCategories();
    await loadProjects();
    loadRecentExpenses();
    loadRecentIncomes();
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabName));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === `tab-${tabName}`));
    if (tabName === 'records') loadAllRecords();
}

// ============ åˆ†é¡ç®¡ç† ============
async function loadCategories() {
    try {
        const ed = await db.collection('users').doc(currentUserId).collection('settings').doc('expenseCategories').get();
        if (ed.exists) { expenseCategories = ed.data().list || []; }
        else { expenseCategories = [...DEFAULT_EXPENSE_CATEGORIES]; await saveCategories('expense'); }

        const id = await db.collection('users').doc(currentUserId).collection('settings').doc('incomeCategories').get();
        if (id.exists) { incomeCategories = id.data().list || []; }
        else { incomeCategories = [...DEFAULT_INCOME_CATEGORIES]; await saveCategories('income'); }

        updateCategoryDropdowns();
        renderCategoryTags();
    } catch (e) { console.error(e); showToast('è¼‰å…¥åˆ†é¡å¤±æ•—', 'error'); }
}

async function saveCategories(type) {
    const docName = type === 'expense' ? 'expenseCategories' : 'incomeCategories';
    const list = type === 'expense' ? expenseCategories : incomeCategories;
    await db.collection('users').doc(currentUserId).collection('settings').doc(docName).set({ list });
}

function updateCategoryDropdowns() {
    const ec = document.getElementById('expense-category');
    ec.innerHTML = '<option value="">-- é¸æ“‡ç¨®é¡ --</option>' + expenseCategories.map(c => `<option value="${c}">${c}</option>`).join('');
    const ic = document.getElementById('income-category');
    ic.innerHTML = '<option value="">-- é¸æ“‡ç¨®é¡ --</option>' + incomeCategories.map(c => `<option value="${c}">${c}</option>`).join('');
}

function renderCategoryTags() {
    document.getElementById('expense-categories-list').innerHTML = expenseCategories.map(c =>
        `<span class="tag-item">${c} <i class="fas fa-times tag-delete" onclick="removeCategory('expense',\`${c}\`)"></i></span>`
    ).join('');
    document.getElementById('income-categories-list').innerHTML = incomeCategories.map(c =>
        `<span class="tag-item">${c} <i class="fas fa-times tag-delete" onclick="removeCategory('income',\`${c}\`)"></i></span>`
    ).join('');
}

async function addCategory(type) {
    const inputId = type === 'expense' ? 'new-expense-category' : 'new-income-category';
    const input = document.getElementById(inputId);
    const name = input.value.trim();
    if (!name) return;
    const list = type === 'expense' ? expenseCategories : incomeCategories;
    if (list.includes(name)) { showToast('æ­¤ç¨®é¡å·²å­˜åœ¨', 'error'); return; }
    list.push(name);
    await saveCategories(type);
    updateCategoryDropdowns(); renderCategoryTags();
    input.value = '';
    showToast(`å·²æ–°å¢ç¨®é¡: ${name}`, 'success');
}

async function removeCategory(type, name) {
    if (!confirm(`ç¢ºå®šåˆªé™¤ç¨®é¡ã€Œ${name}ã€ï¼Ÿ`)) return;
    if (type === 'expense') expenseCategories = expenseCategories.filter(c => c !== name);
    else incomeCategories = incomeCategories.filter(c => c !== name);
    await saveCategories(type);
    updateCategoryDropdowns(); renderCategoryTags();
    showToast(`å·²åˆªé™¤ç¨®é¡: ${name}`, 'info');
}

// ============ Project ç®¡ç† ============
async function loadProjects() {
    try {
        const doc = await db.collection('users').doc(currentUserId).collection('settings').doc('projects').get();
        projects = doc.exists ? (doc.data().list || []) : [];
        updateProjectDropdowns(); renderProjectTags();
    } catch (e) { console.error(e); }
}

async function saveProjects() {
    await db.collection('users').doc(currentUserId).collection('settings').doc('projects').set({ list: projects });
}

function updateProjectDropdowns() {
    ['expense-project', 'income-project'].forEach(id => {
        document.getElementById(id).innerHTML = '<option value="">-- é¸æ“‡ Project --</option>' +
            projects.map(p => `<option value="${p}">${p}</option>`).join('');
    });
}

function renderProjectTags() {
    document.getElementById('projects-list').innerHTML = projects.map(p =>
        `<span class="tag-item">${p} <i class="fas fa-times tag-delete" onclick="removeProject(\`${p}\`)"></i></span>`
    ).join('');
}

async function addProject() {
    const input = document.getElementById('new-project');
    const name = input.value.trim();
    if (!name) return;
    if (projects.includes(name)) { showToast('æ­¤ Project å·²å­˜åœ¨', 'error'); return; }
    projects.push(name);
    await saveProjects(); updateProjectDropdowns(); renderProjectTags();
    input.value = '';
    showToast(`å·²æ–°å¢ Project: ${name}`, 'success');
}

async function removeProject(name) {
    if (!confirm(`ç¢ºå®šåˆªé™¤ Projectã€Œ${name}ã€ï¼Ÿ`)) return;
    projects = projects.filter(p => p !== name);
    await saveProjects(); updateProjectDropdowns(); renderProjectTags();
    showToast(`å·²åˆªé™¤ Project: ${name}`, 'info');
}

// ============ æ–°å¢æ”¯å‡º ============
async function addExpense() {
    const amount = parseFloat(document.getElementById('expense-amount').value);
    const date = document.getElementById('expense-date').value;
    const method = document.getElementById('expense-method').value;
    const category = document.getElementById('expense-category').value;
    const project = document.getElementById('expense-project').value;
    const note = document.getElementById('expense-note').value.trim();

    if (!amount || amount <= 0) { showToast('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡', 'error'); return; }
    if (!date) { showToast('è«‹é¸æ“‡æ—¥æœŸ', 'error'); return; }
    if (!category) { showToast('è«‹é¸æ“‡è²»ç”¨ç¨®é¡', 'error'); return; }

    try {
        await db.collection('users').doc(currentUserId).collection('expenses').add({
            amount, date, method, category, project, note,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('expense-amount').value = '';
        document.getElementById('expense-note').value = '';
        showToast(`å·²è¨˜éŒ„æ”¯å‡º 
$$
{amount.toFixed(2)}`, 'success');
        loadRecentExpenses();
    } catch (e) { console.error(e); showToast('æ–°å¢æ”¯å‡ºå¤±æ•—', 'error'); }
}

// ============ æ–°å¢æ”¶å…¥ ============
async function addIncome() {
    const amount = parseFloat(document.getElementById('income-amount').value);
    const date = document.getElementById('income-date').value;
    const method = document.getElementById('income-method').value;
    const category = document.getElementById('income-category').value;
    const project = document.getElementById('income-project').value;
    const note = document.getElementById('income-note').value.trim();

    if (!amount || amount <= 0) { showToast('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡', 'error'); return; }
    if (!date) { showToast('è«‹é¸æ“‡æ—¥æœŸ', 'error'); return; }
    if (!category) { showToast('è«‹é¸æ“‡æ”¶å…¥ç¨®é¡', 'error'); return; }

    try {
        await db.collection('users').doc(currentUserId).collection('incomes').add({
            amount, date, method, category, project, note,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('income-amount').value = '';
        document.getElementById('income-note').value = '';
        showToast(`å·²è¨˜éŒ„æ”¶å…¥
$$
{amount.toFixed(2)}`, 'success');
        loadRecentIncomes();
    } catch (e) { console.error(e); showToast('æ–°å¢æ”¶å…¥å¤±æ•—', 'error'); }
}

// ============ è¼‰å…¥æœ€è¿‘æ”¯å‡º ============
async function loadRecentExpenses() {
    const container = document.getElementById('recent-expenses');
    container.innerHTML = '<p class="empty-msg"><span class="loading-spinner"></span> è¼‰å…¥ä¸­...</p>';
    try {
        const snap = await db.collection('users').doc(currentUserId)
            .collection('expenses').orderBy('date', 'desc').limit(10).get();
        if (snap.empty) { container.innerHTML = '<p class="empty-msg">å°šç„¡æ”¯å‡ºè¨˜éŒ„</p>'; return; }
        container.innerHTML = '';
        snap.forEach(doc => { container.innerHTML += createRecordHTML(doc.id, doc.data(), 'expense'); });
    } catch (e) { console.error(e); container.innerHTML = '<p class="empty-msg">è¼‰å…¥å¤±æ•—</p>'; }
}

// ============ è¼‰å…¥æœ€è¿‘æ”¶å…¥ ============
async function loadRecentIncomes() {
    const container = document.getElementById('recent-incomes');
    container.innerHTML = '<p class="empty-msg"><span class="loading-spinner"></span> è¼‰å…¥ä¸­...</p>';
    try {
        const snap = await db.collection('users').doc(currentUserId)
            .collection('incomes').orderBy('date', 'desc').limit(10).get();
        if (snap.empty) { container.innerHTML = '<p class="empty-msg">å°šç„¡æ”¶å…¥è¨˜éŒ„</p>'; return; }
        container.innerHTML = '';
        snap.forEach(doc => { container.innerHTML += createRecordHTML(doc.id, doc.data(), 'income'); });
    } catch (e) { console.error(e); container.innerHTML = '<p class="empty-msg">è¼‰å…¥å¤±æ•—</p>'; }
}

// ============ è¼‰å…¥æ‰€æœ‰è¨˜éŒ„ ============
async function loadAllRecords() {
    const container = document.getElementById('all-records');
    container.innerHTML = '<p class="empty-msg"><span class="loading-spinner"></span> è¼‰å…¥ä¸­...</p>';
    const filterType = document.getElementById('records-filter-type').value;
    const startDate = document.getElementById('records-filter-start').value;
    const endDate = document.getElementById('records-filter-end').value;

    try {
        let allRecords = [];

        if (filterType === 'all' || filterType === 'expense') {
            let q = db.collection('users').doc(currentUserId).collection('expenses').orderBy('date', 'desc');
            if (startDate) q = q.where('date', '>=', startDate);
            if (endDate) q = q.where('date', '<=', endDate);
            const snap = await q.get();
            snap.forEach(doc => allRecords.push({ id: doc.id, type: 'expense', ...doc.data() }));
        }

        if (filterType === 'all' || filterType === 'income') {
            let q = db.collection('users').doc(currentUserId).collection('incomes').orderBy('date', 'desc');
            if (startDate) q = q.where('date', '>=', startDate);
            if (endDate) q = q.where('date', '<=', endDate);
            const snap = await q.get();
            snap.forEach(doc => allRecords.push({ id: doc.id, type: 'income', ...doc.data() }));
        }

        allRecords.sort((a, b) => b.date.localeCompare(a.date));

        if (allRecords.length === 0) { container.innerHTML = '<p class="empty-msg">æ­¤æœŸé–“ç„¡è¨˜éŒ„</p>'; return; }
        container.innerHTML = '';
        allRecords.forEach(r => { container.innerHTML += createRecordHTML(r.id, r, r.type); });
    } catch (e) { console.error(e); container.innerHTML = '<p class="empty-msg">è¼‰å…¥å¤±æ•—</p>'; }
}

// ============ è¨˜éŒ„ HTML ============
function createRecordHTML(id, data, type) {
    const icon = type === 'expense' ? 'fa-arrow-down' : 'fa-arrow-up';
    const sign = type === 'expense' ? '-' : '+';
    const me = data.method === 'ç¾é‡‘' ? 'ğŸ’µ' : data.method === 'éŠ€è¡Œ' ? 'ğŸ¦' : 'ğŸ’³';
    return `
        <div class="record-item">
            <div class="record-icon ${type}"><i class="fas ${icon}"></i></div>
            <div class="record-info">
                <div class="record-title">${data.category}${data.project ? ' Â· ' + data.project : ''}</div>
                <div class="record-meta">${data.date} Â· ${me} ${data.method}${data.note ? ' Â· ' + data.note : ''}</div>
            </div>
            <div class="record-amount ${type}">${sign}$${data.amount.toFixed(2)}</div>
            <div class="record-actions">
                <button class="btn btn-xs btn-outline" onclick="editRecord('${id}','${type}')" title="ç·¨è¼¯"><i class="fas fa-edit"></i></button>
                <button class="btn btn-xs btn-outline" onclick="deleteRecord('${id}','${type}')" title="åˆªé™¤"><i class="fas fa-trash"></i></button>
            </div>
        </div>`;
}

// ============ åˆªé™¤è¨˜éŒ„ ============
async function deleteRecord(id, type) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨˜éŒ„ï¼Ÿ')) return;
    const col = type === 'expense' ? 'expenses' : 'incomes';
    try {
        await db.collection('users').doc(currentUserId).collection(col).doc(id).delete();
        showToast('å·²åˆªé™¤è¨˜éŒ„', 'info');
        if (type === 'expense') loadRecentExpenses(); else loadRecentIncomes();
        if (document.getElementById('tab-records').classList.contains('active')) loadAllRecords();
    } catch (e) { console.error(e); showToast('åˆªé™¤å¤±æ•—', 'error'); }
}

// ============ ç·¨è¼¯è¨˜éŒ„ ============
async function editRecord(id, type) {
    const col = type === 'expense' ? 'expenses' : 'incomes';
    try {
        const doc = await db.collection('users').doc(currentUserId).collection(col).doc(id).get();
        if (!doc.exists) { showToast('è¨˜éŒ„ä¸å­˜åœ¨', 'error'); return; }
        const data = doc.data();
        const isExp = type === 'expense';
        const cats = isExp ? expenseCategories : incomeCategories;
        const methods = isExp ? ['ç¾é‡‘', 'éŠ€è¡Œ', 'ä¿¡ç”¨å¡'] : ['ç¾é‡‘', 'éŠ€è¡Œ'];

        document.getElementById('edit-modal-title').textContent = isExp ? 'ç·¨è¼¯æ”¯å‡º' : 'ç·¨è¼¯æ”¶å…¥';
        document.getElementById('edit-modal-body').innerHTML = `
            <div class="form-group"><label>é‡‘é¡</label><input type="number" id="edit-amount" value="${data.amount}" step="0.01" min="0"></div>
            <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="edit-date" value="${data.date}"></div>
            <div class="form-group"><label>${isExp ? 'æ”¯å‡º' : 'æ”¶å…¥'}å½¢å¼</label>
                <select id="edit-method">${methods.map(m => `<option value="${m}" ${data.method === m ? 'selected' : ''}>${m}</option>`).join('')}</select></div>
            <div class="form-group"><label>ç¨®é¡</label>
                <select id="edit-category">${cats.map(c => `<option value="${c}" ${data.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div>
            <div class="form-group"><label>Project</label>
                <select id="edit-project"><option value="">-- ç„¡ --</option>${projects.map(p => `<option value="${p}" ${data.project === p ? 'selected' : ''}>${p}</option>`).join('')}</select></div>
            <div class="form-group"><label>å‚™è¨»</label><input type="text" id="edit-note" value="${data.note || ''}"></div>`;

        document.getElementById('edit-modal').style.display = 'flex';

        document.getElementById('edit-