<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’° ç°¡å–®è²¡å‹™è¨˜è³¬ç³»çµ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}:root{--primary:#4f46e5;--primary-dark:#3730a3;--success:#10b981;--danger:#ef4444;--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;--gray-400:#9ca3af;--gray-500:#6b7280;--gray-600:#4b5563;--gray-700:#374151;--gray-800:#1f2937;--shadow:0 1px 3px rgba(0,0,0,.12);--shadow-lg:0 10px 15px -3px rgba(0,0,0,.1);--radius:12px;--radius-sm:8px}body{font-family:'Noto Sans TC',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--gray-100);color:var(--gray-800);min-height:100vh}.auth-container{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px}.auth-card{background:#fff;border-radius:20px;padding:40px;width:100%;max-width:440px;box-shadow:var(--shadow-lg)}.auth-header{text-align:center;margin-bottom:30px}.auth-icon{font-size:48px;color:var(--primary);margin-bottom:10px}.auth-header h1{font-size:28px;color:var(--gray-800);margin-bottom:5px}.auth-header p{color:var(--gray-500);font-size:14px}.auth-form h2{font-size:20px;margin-bottom:20px;color:var(--gray-700)}.form-group{margin-bottom:16px}.form-group label{display:block;font-size:13px;font-weight:500;color:var(--gray-600);margin-bottom:6px}.form-group input,.form-group select{width:100%;padding:10px 14px;border:2px solid var(--gray-200);border-radius:var(--radius-sm);font-size:14px;font-family:inherit;background:#fff}.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,.1)}.form-row{display:flex;gap:16px}.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 20px;border:none;border-radius:var(--radius-sm);font-size:14px;font-weight:500;font-family:inherit;cursor:pointer;transition:all .2s}.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-dark)}.btn-success{background:var(--success);color:#fff}.btn-danger{background:var(--danger);color:#fff}.btn-outline{background:transparent;color:var(--gray-600);border:2px solid var(--gray-300)}.btn-google{background:#fff;color:var(--gray-700);border:2px solid var(--gray-300)}.btn-full{width:100%}.btn-sm{padding:6px 12px;font-size:13px}.btn-xs{padding:4px 8px;font-size:12px}.divider{text-align:center;margin:20px 0;position:relative}.divider::before{content:'';position:absolute;top:50%;left:0;right:0;height:1px;background:var(--gray-200)}.divider span{background:#fff;padding:0 12px;position:relative;color:var(--gray-400);font-size:13px}.auth-switch{text-align:center;margin-top:20px;font-size:14px;color:var(--gray-500)}.auth-switch a{color:var(--primary);text-decoration:none;font-weight:500;cursor:pointer}.error-message{background:#fef2f2;color:var(--danger);padding:10px 14px;border-radius:var(--radius-sm);font-size:13px;margin-top:16px;border:1px solid #fecaca}.app-container{min-height:100vh}.app-header{background:#fff;padding:12px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow);position:sticky;top:0;z-index:100}.header-left{display:flex;align-items:center;gap:10px}.header-left i{font-size:24px;color:var(--primary)}.header-left h1{font-size:20px;color:var(--gray-800)}.header-right{display:flex;align-items:center;gap:12px}.user-info{font-size:13px;color:var(--gray-500)}.tab-nav{background:#fff;display:flex;overflow-x:auto;border-bottom:2px solid var(--gray-200);padding:0 16px}.tab-btn{flex-shrink:0;display:flex;align-items:center;gap:6px;padding:14px 20px;border:none;background:none;font-size:14px;font-weight:500;font-family:inherit;color:var(--gray-500);cursor:pointer;border-bottom:3px solid transparent;margin-bottom:-2px}.tab-btn.active{color:var(--primary);border-bottom-color:var(--primary)}.main-content{max-width:960px;margin:0 auto;padding:20px}.tab-content{display:none}.tab-content.active{display:block}.card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}.card-header{padding:16px 20px;border-bottom:1px solid var(--gray-100);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}.card-header h2{font-size:16px;display:flex;align-items:center;gap:8px}.card-body{padding:20px}.mt-20{margin-top:20px}.text-success{color:var(--success)}.text-danger{color:var(--danger)}.records-list{max-height:500px;overflow-y:auto}.record-item{display:flex;align-items:center;padding:12px 0;border-bottom:1px solid var(--gray-100);gap:12px}.record-item:last-child{border-bottom:none}.record-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}.record-icon.expense{background:#fef2f2;color:var(--danger)}.record-icon.income{background:#ecfdf5;color:var(--success)}.record-info{flex:1;min-width:0}.record-info .record-title{font-weight:500;font-size:14px;color:var(--gray-800)}.record-info .record-meta{font-size:12px;color:var(--gray-400);margin-top:2px}.record-amount{font-weight:700;font-size:15px;flex-shrink:0}.record-amount.expense{color:var(--danger)}.record-amount.income{color:var(--success)}.record-actions{display:flex;gap:4px;flex-shrink:0}.record-actions .btn-xs{opacity:.6}.empty-msg{text-align:center;color:var(--gray-400);padding:30px;font-size:14px}.filter-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}.filter-row select,.filter-row input{padding:6px 10px;border:2px solid var(--gray-200);border-radius:var(--radius-sm);font-size:13px;font-family:inherit}.summary-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}.summary-card{background:#fff;border-radius:var(--radius);padding:20px;display:flex;align-items:center;gap:16px;box-shadow:var(--shadow)}.summary-icon{width:50px;height:50px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}.income-card .summary-icon{background:#ecfdf5;color:var(--success)}.expense-card .summary-icon{background:#fef2f2;color:var(--danger)}.net-card .summary-icon{background:#eef2ff;color:var(--primary)}.summary-label{display:block;font-size:12px;color:var(--gray-500);margin-bottom:4px}.summary-value{display:block;font-size:22px;font-weight:700;color:var(--gray-800)}.report-table-container{overflow-x:auto}.report-table{width:100%;border-collapse:collapse;font-size:13px}.report-table th{background:var(--gray-50);padding:10px 14px;text-align:left;font-weight:600;color:var(--gray-600);border-bottom:2px solid var(--gray-200);white-space:nowrap}.report-table td{padding:10px 14px;border-bottom:1px solid var(--gray-100);color:var(--gray-700)}.report-table .total-row td{font-weight:700;background:var(--gray-50);border-top:2px solid var(--gray-300)}.settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px}.add-item-row{display:flex;gap:8px;margin-bottom:16px}.add-item-row input{flex:1;padding:8px 12px;border:2px solid var(--gray-200);border-radius:var(--radius-sm);font-size:13px;font-family:inherit}.tags-list{display:flex;flex-wrap:wrap;gap:8px}.tag-item{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:var(--gray-100);border-radius:20px;font-size:13px;color:var(--gray-700)}.tag-item .tag-delete{cursor:pointer;color:var(--gray-400);font-size:12px}.toast-container{position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px}.toast{padding:12px 20px;border-radius:var(--radius-sm);font-size:14px;color:#fff;box-shadow:var(--shadow-lg);animation:toastIn .3s ease,toastOut .3s ease 2.7s forwards;max-width:350px}.toast.success{background:var(--success)}.toast.error{background:var(--danger)}.toast.info{background:var(--primary)}@keyframes toastIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes toastOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}.modal{position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center}.modal-overlay{position:absolute;inset:0;background:rgba(0,0,0,.5)}.modal-content{position:relative;background:#fff;border-radius:var(--radius);width:90%;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg)}.modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--gray-200)}.modal-header h3{font-size:16px}.btn-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--gray-400);line-height:1}.modal-body{padding:20px}.modal-footer{padding:12px 20px;border-top:1px solid var(--gray-200);display:flex;justify-content:flex-end;gap:8px}.loading-spinner{display:inline-block;width:20px;height:20px;border:2px solid var(--gray-200);border-top-color:var(--primary);border-radius:50%;animation:spin .6s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}@media(max-width:768px){.form-row{flex-direction:column}.summary-cards{grid-template-columns:1fr}.settings-grid{grid-template-columns:1fr}}::-webkit-scrollbar{width:6px}::-webkit-scrollbar-thumb{background:var(--gray-300);border-radius:3px}
</style>
</head>
<body>

<!-- ç™»å…¥é é¢ -->
<div id="auth-container" class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <i class="fas fa-wallet auth-icon"></i>
            <h1>ç°¡å–®è²¡å‹™è¨˜è³¬</h1>
            <p>è¼•é¬†ç®¡ç†ä½ çš„æ”¶å…¥èˆ‡æ”¯å‡º</p>
        </div>
        <div id="login-form" class="auth-form">
            <h2>ç™»å…¥</h2>
            <div class="form-group"><label><i class="fas fa-envelope"></i> é›»å­éƒµä»¶</label><input type="email" id="login-email" placeholder="your@email.com"></div>
            <div class="form-group"><label><i class="fas fa-lock"></i> å¯†ç¢¼</label><input type="password" id="login-password" placeholder="è¼¸å…¥å¯†ç¢¼"></div>
            <button class="btn btn-primary btn-full" onclick="loginWithEmail()"><i class="fas fa-sign-in-alt"></i> ç™»å…¥</button>
            <div class="divider"><span>æˆ–</span></div>
            <button class="btn btn-google btn-full" onclick="loginWithGoogle()"><i class="fab fa-google"></i> ä½¿ç”¨ Google ç™»å…¥</button>
            <p class="auth-switch">é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ<a onclick="showRegister()">ç«‹å³è¨»å†Š</a></p>
        </div>
        <div id="register-form" class="auth-form" style="display:none;">
            <h2>è¨»å†Š</h2>
            <div class="form-group"><label><i class="fas fa-envelope"></i> é›»å­éƒµä»¶</label><input type="email" id="register-email" placeholder="your@email.com"></div>
            <div class="form-group"><label><i class="fas fa-lock"></i> å¯†ç¢¼ï¼ˆè‡³å°‘6ä½ï¼‰</label><input type="password" id="register-password" placeholder="è¨­å®šå¯†ç¢¼"></div>
            <div class="form-group"><label><i class="fas fa-lock"></i> ç¢ºèªå¯†ç¢¼</label><input type="password" id="register-password-confirm" placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼"></div>
            <button class="btn btn-primary btn-full" onclick="registerWithEmail()"><i class="fas fa-user-plus"></i> è¨»å†Š</button>
            <div class="divider"><span>æˆ–</span></div>
            <button class="btn btn-google btn-full" onclick="loginWithGoogle()"><i class="fab fa-google"></i> ä½¿ç”¨ Google è¨»å†Š</button>
            <p class="auth-switch">å·²æœ‰å¸³è™Ÿï¼Ÿ<a onclick="showLogin()">è¿”å›ç™»å…¥</a></p>
        </div>
        <div id="auth-error" class="error-message" style="display:none;"></div>
    </div>
</div>

<!-- ä¸»æ‡‰ç”¨ -->
<div id="app-container" class="app-container" style="display:none;">
    <header class="app-header">
        <div class="header-left"><i class="fas fa-wallet"></i><h1>è²¡å‹™è¨˜è³¬</h1></div>
        <div class="header-right"><span id="user-display" class="user-info"></span><button class="btn btn-sm btn-outline" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ç™»å‡º</button></div>
    </header>
    <nav class="tab-nav">
        <button class="tab-btn active" data-tab="expense" onclick="switchTab('expense')"><i class="fas fa-arrow-down text-danger"></i> æ”¯å‡º</button>
        <button class="tab-btn" data-tab="income" onclick="switchTab('income')"><i class="fas fa-arrow-up text-success"></i> æ”¶å…¥</button>
        <button class="tab-btn" data-tab="records" onclick="switchTab('records')"><i class="fas fa-list"></i> è¨˜éŒ„</button>
        <button class="tab-btn" data-tab="reports" onclick="switchTab('reports')"><i class="fas fa-chart-bar"></i> å ±è¡¨</button>
        <button class="tab-btn" data-tab="settings" onclick="switchTab('settings')"><i class="fas fa-cog"></i> è¨­å®š</button>
    </nav>
    <main class="main-content">
        <div id="tab-expense" class="tab-content active">
            <div class="card">
                <div class="card-header"><h2><i class="fas fa-minus-circle text-danger"></i> æ–°å¢æ”¯å‡º</h2></div>
                <div class="card-body">
                    <div class="form-row"><div class="form-group"><label>é‡‘é¡ *</label><input type="number" id="expense-amount" placeholder="0.00" step="0.01" min="0"></div><div class="form-group"><label>æ—¥æœŸ *</label><input type="date" id="expense-date"></div></div>
                    <div class="form-row"><div class="form-group"><label>å½¢å¼ *</label><select id="expense-method"><option value="ç¾é‡‘">ğŸ’µ ç¾é‡‘</option><option value="éŠ€è¡Œ">ğŸ¦ éŠ€è¡Œ</option><option value="ä¿¡ç”¨å¡">ğŸ’³ ä¿¡ç”¨å¡</option></select></div><div class="form-group"><label>ç¨®é¡ *</label><select id="expense-category"><option value="">-- é¸æ“‡ --</option></select></div></div>
                    <div class="form-row"><div class="form-group"><label>Project</label><select id="expense-project"><option value="">-- ç„¡ --</option></select></div><div class="form-group"><label>å‚™è¨»</label><input type="text" id="expense-note" placeholder="é¸å¡«"></div></div>
                    <button class="btn btn-danger btn-full" onclick="addExpense()"><i class="fas fa-plus"></i> æ–°å¢æ”¯å‡º</button>
                </div>
            </div>
            <div class="card mt-20"><div class="card-header"><h2><i class="fas fa-history"></i> æœ€è¿‘æ”¯å‡º</h2></div><div class="card-body"><div id="recent-expenses" class="records-list"><p class="empty-msg">è¼‰å…¥ä¸­...</p></div></div></div>
        </div>
        <div id="tab-income" class="tab-content">
            <div class="card">
                <div class="card-header"><h2><i class="fas fa-plus-circle text-success"></i> æ–°å¢æ”¶å…¥</h2></div>
                <div class="card-body">
                    <div class="form-row"><div class="form-group"><label>é‡‘é¡ *</label><input type="number" id="income-amount" placeholder="0.00" step="0.01" min="0"></div><div class="form-group"><label>æ—¥æœŸ *</label><input type="date" id="income-date"></div></div>
                    <div class="form-row"><div class="form-group"><label>å½¢å¼ *</label><select id="income-method"><option value="ç¾é‡‘">ğŸ’µ ç¾é‡‘</option><option value="éŠ€è¡Œ">ğŸ¦ éŠ€è¡Œ</option></select></div><div class="form-group"><label>ç¨®é¡ *</label><select id="income-category"><option value="">-- é¸æ“‡ --</option></select></div></div>
                    <div class="form-row"><div class="form-group"><label>Project</label><select id="income-project"><option value="">-- ç„¡ --</option></select></div><div class="form-group"><label>å‚™è¨»</label><input type="text" id="income-note" placeholder="é¸å¡«"></div></div>
                    <button class="btn btn-success btn-full" onclick="addIncome()"><i class="fas fa-plus"></i> æ–°å¢æ”¶å…¥</button>
                </div>
            </div>
            <div class="card mt-20"><div class="card-header"><h2><i class="fas fa-history"></i> æœ€è¿‘æ”¶å…¥</h2></div><div class="card-body"><div id="recent-incomes" class="records-list"><p class="empty-msg">è¼‰å…¥ä¸­...</p></div></div></div>
        </div>
        <div id="tab-records" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-list-alt"></i> æ‰€æœ‰è¨˜éŒ„</h2>
                    <div class="filter-row"><select id="records-filter-type" onchange="loadAllRecords()"><option value="all">å…¨éƒ¨</option><option value="expense">æ”¯å‡º</option><option value="income">æ”¶å…¥</option></select><input type="date" id="records-filter-start" onchange="loadAllRecords()"><span>ï½</span><input type="date" id="records-filter-end" onchange="loadAllRecords()"></div>
                </div>
                <div class="card-body"><div id="all-records" class="records-list"><p class="empty-msg">è¼‰å…¥ä¸­...</p></div></div>
            </div>
        </div>
        <div id="tab-reports" class="tab-content">
            <div class="card">
                <div class="card-header"><h2><i class="fas fa-chart-pie"></i> è²¡å‹™å ±è¡¨</h2></div>
                <div class="card-body"><div class="form-row"><div class="form-group"><label>é–‹å§‹æ—¥æœŸ</label><input type="date" id="report-start"></div><div class="form-group"><label>çµæŸæ—¥æœŸ</label><input type="date" id="report-end"></div><div class="form-group" style="display:flex;align-items:flex-end"><button class="btn btn-primary" onclick="generateReports()"><i class="fas fa-search"></i> ç”Ÿæˆ</button></div></div></div>
            </div>
            <div class="summary-cards mt-20" id="report-summary" style="display:none;">
                <div class="summary-card income-card"><div class="summary-icon"><i class="fas fa-arrow-up"></i></div><div class="summary-info"><span class="summary-label">ç¸½æ”¶å…¥</span><span class="summary-value" id="report-total-income">\$0</span></div></div>
                <div class="summary-card expense-card"><div class="summary-icon"><i class="fas fa-arrow-down"></i></div><div class="summary-info"><span class="summary-label">ç¸½æ”¯å‡º</span><span class="summary-value" id="report-total-expense">\$0</span></div></div>
                <div class="summary-card net-card"><div class="summary-icon"><i class="fas fa-balance-scale"></i></div><div class="summary-info"><span class="summary-label">æ·¨é¡</span><span class="summary-value" id="report-net">\$0</span></div></div>
            </div>
            <div class="card mt-20" id="report-income-section" style="display:none;"><div class="card-header"><h2><i class="fas fa-arrow-up text-success"></i> æ”¶å…¥å ±è¡¨</h2></div><div class="card-body"><div id="report-income-detail" class="report-table-container"></div></div></div>
            <div class="card mt-20" id="report-expense-section" style="display:none;"><div class="card-header"><h2><i class="fas fa-arrow-down text-danger"></i> æ”¯å‡ºå ±è¡¨</h2></div><div class="card-body"><div id="report-expense-detail" class="report-table-container"></div></div></div>
            <div class="card mt-20" id="report-all-section" style="display:none;"><div class="card-header"><h2><i class="fas fa-exchange-alt"></i> ç¸½è¡¨</h2></div><div class="card-body"><div id="report-all-detail" class="report-table-container"></div></div></div>
        </div>
        <div id="tab-settings" class="tab-content">
            <div class="settings-grid">
                <div class="card"><div class="card-header"><h2><i class="fas fa-tags text-danger"></i> æ”¯å‡ºç¨®é¡</h2></div><div class="card-body"><div class="add-item-row"><input type="text" id="new-expense-category" placeholder="æ–°å¢" onkeypress="if(event.key==='Enter')addCategory('expense')"><button class="btn btn-sm btn-primary" onclick="addCategory('expense')"><i class="fas fa-plus"></i></button></div><div id="expense-categories-list" class="tags-list"></div></div></div>
                <div class="card"><div class="card-header"><h2><i class="fas fa-tags text-success"></i> æ”¶å…¥ç¨®é¡</h2></div><div class="card-body"><div class="add-item-row"><input type="text" id="new-income-category" placeholder="æ–°å¢" onkeypress="if(event.key==='Enter')addCategory('income')"><button class="btn btn-sm btn-primary" onclick="addCategory('income')"><i class="fas fa-plus"></i></button></div><div id="income-categories-list" class="tags-list"></div></div></div>
                <div class="card"><div class="card-header"><h2><i class="fas fa-project-diagram"></i> Projects</h2></div><div class="card-body"><div class="add-item-row"><input type="text" id="new-project" placeholder="æ–°å¢" onkeypress="if(event.key==='Enter')addProject()"><button class="btn btn-sm btn-primary" onclick="addProject()"><i class="fas fa-plus"></i></button></div><div id="projects-list" class="tags-list"></div></div></div>
            </div>
        </div>
    </main>
</div>

<div id="toast-container" class="toast-container"></div>
<div id="edit-modal" class="modal" style="display:none;">
    <div class="modal-overlay" onclick="closeEditModal()"></div>
    <div class="modal-content">
        <div class="modal-header"><h3 id="edit-modal-title">ç·¨è¼¯</h3><button class="btn-close" onclick="closeEditModal()">&times;</button></div>
        <div class="modal-body" id="edit-modal-body"></div>
        <div class="modal-footer"><button class="btn btn-outline" onclick="closeEditModal()">å–æ¶ˆ</button><button class="btn btn-primary" id="edit-modal-save">å„²å­˜</button></div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// âš ï¸ è«‹å¡«å…¥ä½ çš„ Firebase è¨­å®š
const firebaseConfig = {
    apiKey: "AIzaSyAcZrnL8Aze4ZIlh6RgornQ0oBd6xa092M",
    authDomain: "simple-books-700d7.firebaseapp.com",
    projectId: "simple-books-700d7",
    storageBucket: "simple-books-700d7.firebasestorage.app",
    messagingSenderId: "1066770660576",
    appId: "1:1066770660576:web:08637e911bb3852fbaa485",
    measurementId: "G-NRS5F5X9ZS"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const googleProvider = new firebase.auth.GoogleAuthProvider();

// ================= èªè­‰å‡½æ•¸ =================
function showLogin() {
    document.getElementById('login-form').style.display = 'block';
    document.getElementById('register-form').style.display = 'none';
    document.getElementById('auth-error').style.display = 'none';
}

function showRegister() {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('register-form').style.display = 'block';
    document.getElementById('auth-error').style.display = 'none';
}

function showAuthError(msg) {
    document.getElementById('auth-error').textContent = msg;
    document.getElementById('auth-error').style.display = 'block';
}

async function loginWithEmail() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    if (!email || !password) {
        showAuthError('è«‹å¡«å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼');
        return;
    }
    try {
        await auth.signInWithEmailAndPassword(email, password);
        document.getElementById('login-email').value = '';
        document.getElementById('login-password').value = '';
    } catch (error) {
        showAuthError(getAuthErr(error.code));
    }
}

async function registerWithEmail() {
    const email = document.getElementById('register-email').value.trim();
    const pw = document.getElementById('register-password').value;
    const pw2 = document.getElementById('register-password-confirm').value;
    if (!email || !pw) {
        showAuthError('è«‹å¡«å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼');
        return;
    }
    if (pw !== pw2) {
        showAuthError('å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´');
        return;
    }
    if (pw.length < 6) {
        showAuthError('å¯†ç¢¼è‡³å°‘éœ€è¦6å€‹å­—å…ƒ');
        return;
    }
    try {
        await auth.createUserWithEmailAndPassword(email, pw);
        document.getElementById('register-email').value = '';
        document.getElementById('register-password').value = '';
        document.getElementById('register-password-confirm').value = '';
    } catch (error) {
        showAuthError(getAuthErr(error.code));
    }
}

async function loginWithGoogle() {
    try {
        await auth.signInWithPopup(googleProvider);
    } catch (error) {
        if (error.code !== 'auth/popup-closed-by-user') {
            showAuthError(getAuthErr(error.code));
        }
    }
}

async function logout() {
    try {
        await auth.signOut();
    } catch (error) {
        showToast('ç™»å‡ºå¤±æ•—', 'error');
    }
}

function getAuthErr(code) {
    const msgs = {
        'auth/user-not-found': 'æ­¤é›»å­éƒµä»¶å°šæœªè¨»å†Š',
        'auth/wrong-password': 'å¯†ç¢¼éŒ¯èª¤',
        'auth/email-already-in-use': 'æ­¤é›»å­éƒµä»¶å·²è¢«è¨»å†Š',
        'auth/weak-password': 'å¯†ç¢¼è‡³å°‘éœ€è¦6å€‹å­—å…ƒ',
        'auth/invalid-email': 'é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢º',
        'auth/too-many-requests': 'å˜—è©¦æ¬¡æ•¸éå¤šï¼Œè«‹ç¨å¾Œå†è©¦',
        'auth/network-request-failed': 'ç¶²è·¯é€£ç·šå¤±æ•—',
        'auth/invalid-credential': 'é›»å­éƒµä»¶æˆ–å¯†ç¢¼éŒ¯èª¤'
    };
    return msgs[code] || 'ç™¼ç”ŸéŒ¯èª¤ (' + code + ')';
}

auth.onAuthStateChanged(async (user) => {
    if (user) {
        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        document.getElementById('user-display').textContent = user.email || user.displayName || 'ä½¿ç”¨è€…';
        await initializeApp(user.uid);
    } else {
        document.getElementById('auth-container').style.display = 'flex';
        document.getElementById('app-container').style.display = 'none';
    }
});

// ================= ä¸»æ‡‰ç”¨ =================
let currentUserId = null;
let expenseCategories = [];
let incomeCategories = [];
let projects = [];

const DEF_EXP_CATS = ['é¤é£²','äº¤é€š','ä½æˆ¿','è³¼ç‰©','å¨›æ¨‚','é†«ç™‚','æ•™è‚²','å…¶ä»–'];
const DEF_INC_CATS = ['è–ªè³‡','æŠ•è³‡','å…¼è·','çé‡‘','å…¶ä»–'];

async function initializeApp(uid) {
    currentUserId = uid;
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('expense-date').value = today;
    document.getElementById('income-date').value = today;
    const now = new Date();
    const fd = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    const ld = new Date(now.getFullYear(), now.getMonth()+1, 0).toISOString().split('T')[0];
    document.getElementById('report-start').value = fd;
    document.getElementById('report-end').value = ld;
    document.getElementById('records-filter-start').value = fd;
    document.getElementById('records-filter-end').value = ld;
    await loadCategories();
    await loadProjects();
    loadRecentExpenses();
    loadRecentIncomes();
}

function showToast(msg, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = msg;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function switchTab(name) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === name));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === `tab-${name}`));
    if (name === 'records') loadAllRecords();
}

// ================= åˆ†é¡ =================
async function loadCategories() {
    try {
        let doc = await db.collection('users').doc(currentUserId).collection('settings').doc('expenseCategories').get();
        if (doc.exists) {
            expenseCategories = doc.data().list || [];
        } else {
            expenseCategories = [...DEF_EXP_CATS];
            await saveCats('expense');
        }
        doc = await db.collection('users').doc(currentUserId).collection('settings').doc('incomeCategories').get();
        if (doc.exists) {
            incomeCategories = doc.data().list || [];
        } else {
            incomeCategories = [...DEF_INC_CATS];
            await saveCats('income');
        }
        updateCatDD();
        renderCatTags();
    } catch (e) {
        console.error(e);
        showToast('è¼‰å…¥åˆ†é¡å¤±æ•—', 'error');
    }
}

async function saveCats(type) {
    const name = type === 'expense' ? 'expenseCategories' : 'incomeCategories';
    const list = type === 'expense' ? expenseCategories : incomeCategories;
    await db.collection('users').doc(currentUserId).collection('settings').doc(name).set({ list });
}

function updateCatDD() {
    let html = '<option value="">-- é¸æ“‡ --</option>';
    expenseCategories.forEach(c => html += `<option value="${c}">${c}</option>`);
    document.getElementById('expense-category').innerHTML = html;
    
    html = '<option value="">-- é¸æ“‡ --</option>';
    incomeCategories.forEach(c => html += `<option value="${c}">${c}</option>`);
    document.getElementById('income-category').innerHTML = html;
}

function renderCatTags() {
    let html = '';
    expenseCategories.forEach(c => {
        html += `<span class="tag-item">${c} <i class="fas fa-times tag-delete" onclick="removeCat('expense','${c}')"></i></span>`;
    });
    document.getElementById('expense-categories-list').innerHTML = html;
    
    html = '';
    incomeCategories.forEach(c => {
        html += `<span class="tag-item">${c} <i class="fas fa-times tag-delete" onclick="removeCat('income','${c}')"></i></span>`;
    });
    document.getElementById('income-categories-list').innerHTML = html;
}

async function addCategory(type) {
    const inputId = type === 'expense' ? 'new-expense-category' : 'new-income-category';
    const input = document.getElementById(inputId);
    const name = input.value.trim();
    if (!name) return;
    
    const list = type === 'expense' ? expenseCategories : incomeCategories;
    if (list.includes(name)) {
        showToast('æ­¤ç¨®é¡å·²å­˜åœ¨', 'error');
        return;
    }
    list.push(name);
    await saveCats(type);
    updateCatDD();
    renderCatTags();
    input.value = '';
    showToast(`å·²æ–°å¢: ${name}`, 'success');
}

async function removeCat(type, name) {
    if (!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${name}ã€ï¼Ÿ`)) return;
    if (type === 'expense') {
        expenseCategories = expenseCategories.filter(c => c !== name);
    } else {
        incomeCategories = incomeCategories.filter(c => c !== name);
    }
    await saveCats(type);
    updateCatDD();
    renderCatTags();
    showToast(`å·²åˆªé™¤: ${name}`, 'info');
}

// ================= Project =================
async function loadProjects() {
    try {
        const doc = await db.collection('users').doc(currentUserId).collection('settings').doc('projects').get();
        projects = doc.exists ? (doc.data().list || []) : [];
        updateProjDD();
        renderProjTags();
    } catch (e) {
        console.error(e);
    }
}

async function saveProjects() {
    await db.collection('users').doc(currentUserId).collection('settings').doc('projects').set({ list: projects });
}

function updateProjDD() {
    let html = '<option value="">-- ç„¡ --</option>';
    projects.forEach(p => html += `<option value="${p}">${p}</option>`);
    document.getElementById('expense-project').innerHTML = html;
    document.getElementById('income-project').innerHTML = html;
}

function renderProjTags() {
    let html = '';
    projects.forEach(p => {
        html += `<span class="tag-item">${p} <i class="fas fa-times tag-delete" onclick="removeProject('${p}')"></i></span>`;
    });
    document.getElementById('projects-list').innerHTML = html;
}

async function addProject() {
    const input = document.getElementById('new-project');
    const name = input.value.trim();
    if (!name) return;
    if (projects.includes(name)) {
        showToast('å·²å­˜åœ¨', 'error');
        return;
    }
    projects.push(name);
    await saveProjects();
    updateProjDD();
    renderProjTags();
    input.value = '';
    showToast(`å·²æ–°å¢: ${name}`, 'success');
}

async function removeProject(name) {
    if (!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${name}ã€ï¼Ÿ`)) return;
    projects = projects.filter(p => p !== name);
    await saveProjects();
    updateProjDD();
    renderProjTags();
    showToast(`å·²åˆªé™¤: ${name}`, 'info');
}

// ================= æ–°å¢æ”¯å‡º/æ”¶å…¥ =================
async function addExpense() {
    const a = parseFloat(document.getElementById('expense-amount').value);
    const d = document.getElementById('expense-date').value;
    const m = document.getElementById('expense-method').value;
    const c = document.getElementById('expense-category').value;
    const p = document.getElementById('expense-project').value;
    const n = document.getElementById('expense-note').value.trim();

    if (!a || a <= 0) {
        showToast('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡', 'error');
        return;
    }
    if (!d) {
        showToast('è«‹é¸æ“‡æ—¥æœŸ', 'error');
        return;
    }
    if (!c) {
        showToast('è«‹é¸æ“‡ç¨®é¡', 'error');
        return;
    }

    try {
        await db.collection('users').doc(currentUserId).collection('expenses').add({
            amount: a,
            date: d,
            method: m,
            category: c,
            project: p,
            note: n,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('expense-amount').value = '';
        document.getElementById('expense-note').value = '';
        showToast(`å·²è¨˜éŒ„æ”¯å‡º 
$$
{a.toFixed(2)}`, 'success');
        loadRecentExpenses();
    } catch (e) {
        console.error(e);
        showToast('æ–°å¢å¤±æ•—', 'error');
    }
}

async function addIncome() {
    const a = parseFloat(document.getElementById('income-amount').value);
    const d = document.getElementById('income-date').value;
    const m = document.getElementById('income-method').value;
    const c = document.getElementById('income-category').value;
    const p = document.getElementById('income-project').value;
    const n = document.getElementById('income-note').value.trim();

    if (!a || a <= 0) {
        showToast('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡', 'error');
        return;
    }
    if (!d) {
        showToast('è«‹é¸æ“‡æ—¥æœŸ', 'error');
        return;
    }
    if (!c) {
        showToast('è«‹é¸æ“‡ç¨®é¡', 'error');
        return;
    }

    try {
        await db.collection('users').doc(currentUserId).collection('incomes').add({
            amount: a,
            date: d,
            method: m,
            category: c,
            project: p,
            note: n,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('income-amount').value = '';
        document.getElementById('income-note').value = '';
        showToast(`å·²è¨˜éŒ„æ”¶å…¥
$$
{a.toFixed(2)}`, 'success');
        loadRecentIncomes();
    } catch (e) {
        console.error(e);
        showToast('æ–°å¢å¤±æ•—', 'error');
    }
}

// ================= è¼‰å…¥è¨˜éŒ„ =================
async function loadRecentExpenses() {
    const container = document.getElementById('recent-expenses');
    container.innerHTML = '<p class="empty-msg"><span class="loading-spinner"></span> è¼‰å…¥ä¸­...</p>';
    try {
        const snap = await db.collection('users').doc(currentUserId).collection('expenses').orderBy('date', 'desc').limit(10).get();
        if (snap.empty) {
            container.innerHTML = '<p class="empty-msg">å°šç„¡æ”¯å‡ºè¨˜éŒ„</p>';
            return;
        }
        container.innerHTML = '';
        snap.forEach(doc => {
            container.innerHTML += createRecordHTML(doc.id, doc.data(), 'expense');
        });
    } catch (e) {
        container.innerHTML = '<p class="empty-msg">è¼‰å…¥å¤±æ•—</p>';
    }
}

async function loadRecentIncomes() {
    const container = document.getElementById('recent-incomes');
    container.innerHTML = '<p class="empty-msg"><span class="loading-spinner"></span> è¼‰å…¥ä¸­...</p>';
    try {
        const snap = await db.collection('users').doc(currentUserId).collection('incomes').orderBy('date', 'desc').limit(10).get();
        if (snap.empty) {
            container.innerHTML = '<p class="empty-msg">å°šç„¡æ”¶å…¥è¨˜éŒ„</p>';
            return;
        }
        container.innerHTML = '';
        snap.forEach(doc => {
            container.innerHTML += createRecordHTML(doc.id, doc.data(), 'income');
        });
    } catch (e) {
        container.innerHTML = '<p class="empty-msg">è¼‰å…¥å¤±æ•—</p>';
    }
}

async function loadAllRecords() {
    const container = document.getElementById('all-records');
    container.innerHTML = '<p class="empty-msg"><span class="loading-spinner"></span> è¼‰å…¥ä¸­...</p>';
    const ft = document.getElementById('records-filter-type').value;
    const sd = document.getElementById('records-filter-start').value;
    const ed = document.getElementById('records-filter-end').value;

    try {
        let all = [];
        if (ft === 'all' || ft === 'expense') {
            let q = db.collection('users').doc(currentUserId).collection('expenses').orderBy('date', 'desc');
            if (sd) q = q.where('date', '>=', sd);
            if (ed) q = q.where('date', '<=', ed);
            const snap = await q.get();
            snap.forEach(doc => all.push({ id: doc.id, type: 'expense', ...doc.data() }));
        }
        if (ft === 'all' || ft === 'income') {
            let q = db.collection('users').doc(currentUserId).collection('incomes').orderBy('date', 'desc');
            if (sd) q = q.where('date', '>=', sd);
            if (ed) q = q.where('date', '<=', ed);
            const snap = await q.get();
            snap.forEach(doc => all.push({ id: doc.id, type: 'income', ...doc.data() }));
        }
        all.sort((a, b) => b.date.localeCompare(a.date));
        if (!all.length) {
            container.innerHTML = '<p class="empty-msg">æ­¤æœŸé–“ç„¡è¨˜éŒ„</p>';
            return;
        }
        container.innerHTML = '';
        all.forEach(r => {
            container.innerHTML += createRecordHTML(r.id, r, r.type);
        });
    } catch (e) {
        console.error(e);
        container.innerHTML = '<p class="empty-msg">è¼‰å…¥å¤±æ•—</p>';
    }
}

function createRecordHTML(id, data, type) {
    const icon = type === 'expense' ? 'fa-arrow-down' : 'fa-arrow-up';
    const sign = type === 'expense' ? '-' : '+';
    const me = data.method === 'ç¾é‡‘' ? 'ğŸ’µ' : data.method === 'éŠ€è¡Œ' ? 'ğŸ¦' : 'ğŸ’³';
    return `<div class="record-item"><div class="record-icon ${type}"><i class="fas ${icon}"></i></div><div class="record-info"><div class="record-title">${data.category}${data.project ? ' Â· ' + data.project : ''}</div><div class="record-meta">${data.date} Â· ${me} ${data.method}${data.note ? ' Â· ' + data.note : ''}</div></div><div class="record-amount ${type}">${sign}
$$
{data.amount.toFixed(2)}</div><div class="record-actions"><button class="btn btn-xs btn-outline" onclick="editRecord('${id}','${type}')" title="ç·¨è¼¯"><i class="fas fa-edit"></i></button><button class="btn btn-xs btn-outline" onclick="deleteRecord('${id}','${type}')" title="åˆªé™¤"><i class="fas fa-trash"></i></button></div></div>`;
}

async function deleteRecord(id, type) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤ï¼Ÿ')) return;
    const col = type === 'expense' ? 'expenses' : 'incomes';
    try {
        await db.collection('users').doc(currentUserId).collection(col).doc(id).delete();
        showToast('å·²åˆªé™¤', 'info');
        if (type === 'expense') loadRecentExpenses();
        else loadRecentIncomes();
        if (document.getElementById('tab-records').classList.contains('active')) loadAllRecords();
    } catch (e) {
        showToast('åˆªé™¤å¤±æ•—', 'error');
    }
}

async function editRecord(id, type) {
    const col = type === 'expense' ? 'expenses' : 'incomes';
    try {
        const doc = await db.collection('users').doc(currentUserId).collection(col).doc(id).get();
        if (!doc.exists) {
            showToast('è¨˜éŒ„ä¸å­˜åœ¨', 'error');
            return;
        }
        const data = doc.data();
        const isExp = type === 'expense';
        const cats = isExp ? expenseCategories : incomeCategories;
        const methods = isExp ? ['ç¾é‡‘', 'éŠ€è¡Œ', 'ä¿¡ç”¨å¡'] : ['ç¾é‡‘', 'éŠ€è¡Œ'];

        document.getElementById('edit-modal-title').textContent = isExp ? 'ç·¨è¼¯æ”¯å‡º' : 'ç·¨è¼¯æ”¶å…¥';
        let html = `
            <div class="form-group"><label>é‡‘é¡</label><input type="number" id="edit-amount" value="${data.amount}" step="0.01" min="0"></div>
            <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="edit-date" value="${data.date}"></div>
            <div class="form-group"><label>å½¢å¼</label><select id="edit-method">`;
        methods.forEach(m => {
            html += `<option value="${m}" ${data.method === m ? 'selected' : ''}>${m}</option>`;
        });
        html += `</select></div><div class="form-group"><label>ç¨®é¡</label><select id="edit-category">`;
        cats.forEach(c => {
            html += `<option value="${c}" ${data.category === c ? 'selected' : ''}>${c}</option>`;
        });
        html += `</select></div><div class="form-group"><label>Project</label><select id="edit-project"><option value="">-- ç„¡ --</option>`;
        projects.forEach(p => {
            html += `<option value="${p}" ${data.project === p ? 'selected' : ''}>${p}</option>`;
        });
        html += `</select></div><div class="form-group"><label>å‚™è¨»</label><input type="text" id="edit-note" value="${data.note || ''}"></div>`;
        document.getElementById('edit-modal-body').innerHTML = html;
        document.getElementById('edit-modal').style.display = 'flex';

        document.getElementById('edit-modal-save').onclick = async () => {
            const ud = {
                amount: parseFloat(document.getElementById('edit-amount').value),
                date: document.getElementById('edit-date').value,
                method: document.getElementById('edit-method').value,
                category: document.getElementById('edit-category').value,
                project: document.getElementById('edit-project').value,
                note: document.getElementById('edit-note').value.trim()
            };
            if (!ud.amount || ud.amount <= 0) {
                showToast('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡', 'error');
                return;
            }
            try {
                await db.collection('users').doc(currentUserId).collection(col).doc(id).update(ud);
                closeEditModal();
                showToast('å·²æ›´æ–°', 'success');
                if (isExp) loadRecentExpenses();
                else loadRecentIncomes();
                if (document.getElementById('tab-records').classList.contains('active')) loadAllRecords();
            } catch (e) {
                showToast('æ›´æ–°å¤±æ•—', 'error');
            }
        };
    } catch (e) {
        console.error(e);
        showToast('è¼‰å…¥å¤±æ•—', 'error');
    }
}

function closeEditModal() {
    document.getElementById('edit-modal').style.display = 'none';
}

// ================= å ±è¡¨ =================
async function generateReports() {
    const sd = document.getElementById('report-start').value;
    const ed = document.getElementById('report-end').value;
    if (!sd || !ed) {
        showToast('è«‹é¸æ“‡æ—¥æœŸ', 'error');
        return;
    }
    if (sd > ed) {
        showToast('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ', 'error');
        return;
    }
    try {
        const es = await db.collection('users').doc(currentUserId).collection('expenses').where('date', '>=', sd).where('date', '<=', ed).orderBy('date', 'asc').get();
        const expenses = [];
        es.forEach(doc => expenses.push(doc.data()));
        
        const is = await db.collection('users').doc(currentUserId).collection('incomes').where('date', '>=', sd).where('date', '<=', ed).orderBy('date', 'asc').get();
        const incomes = [];
        is.forEach(doc => incomes.push(doc.data()));
        
        const ti = incomes.reduce((s, r) => s + r.amount, 0);
        const te = expenses.reduce((s, r) => s + r.amount, 0);
        const net = ti - te;
        
        document.getElementById('report-total-income').textContent = `
$$
{ti.toFixed(2)}`;
        document.getElementById('report-total-expense').textContent = `
$$
{te.toFixed(2)}`;
        const ne = document.getElementById('report-net');
        ne.textContent = `${net >= 0 ? '+' : ''}
$$
{net.toFixed(2)}`;
        ne.style.color = net >= 0 ? 'var(--success)' : 'var(--danger)';
        
        document.getElementById('report-summary').style.display = 'grid';
        
        // ç”Ÿæˆå ±è¡¨
        if (incomes.length > 0) {
            document.getElementById('report-income-section').style.display = 'block';
            let h = `<p style="margin-bottom:10px;color:var(--gray-500);font-size:13px">ğŸ“… å…± ${incomes.length} ç­†</p>`;
            h += '<h4 style="margin:20px 0 10px;font-size:14px">ğŸ“Š æŒ‰ç¨®é¡</h4><table class="report-table"><thead><tr><th>ç¨®é¡</th><th style="text-align:right">é‡‘é¡</th></tr></thead><tbody>';
            const byCat = {};
            incomes.forEach(r => byCat[r.category] = (byCat[r.category] || 0) + r.amount);
            Object.entries(byCat).sort((a, b) => b[1] - a[1]).forEach(([cat, amt]) => {
                h += `<tr><td>${cat}</td><td style="text-align:right;color:var(--success)">+
$$
{amt.toFixed(2)}</td></tr>`;
            });
            h += `<tr class="total-row"><td><strong>åˆè¨ˆ</strong></td><td style="text-align:right"><strong>+
$$
{ti.toFixed(2)}</strong></td></tr></tbody></table>`;
            document.getElementById('report-income-detail').innerHTML = h;
        } else {
            document.getElementById('report-income-section').style.display = 'none';
        }
        
        if (expenses.length > 0) {
            document.getElementById('report-expense-section').style.display = 'block';
            let h = `<p style="margin-bottom:10px;color:var(--gray-500);font-size:13px">ğŸ“… å…± ${expenses.length} ç­†</p>`;
            h += '<h4 style="margin:20px 0 10px;font-size:14px">ğŸ“Š æŒ‰ç¨®é¡</h4><table class="report-table"><thead><tr><th>ç¨®é¡</th><th style="text-align:right">é‡‘é¡</th></tr></thead><tbody>';
            const byCat = {};
            expenses.forEach(r => byCat[r.category] = (byCat[r.category] || 0) + r.amount);
            Object.entries(byCat).sort((a, b) => b[1] - a[1]).forEach(([cat, amt]) => {
                h += `<tr><td>${cat}</td><td style="text-align:right;color:var(--danger)">-
$$
{amt.toFixed(2)}</td></tr>`;
            });
            h += `<tr class="total-row"><td><strong>åˆè¨ˆ</strong></td><td style="text-align:right"><strong>-
$$
{te.toFixed(2)}</strong></td></tr></tbody></table>`;
            document.getElementById('report-expense-detail').innerHTML = h;
        } else {
            document.getElementById('report-expense-section').style.display = 'none';
        }
        
        showToast('å ±è¡¨å·²ç”Ÿæˆ', 'success');
    } catch (e) {
        console.error(e);
        showToast('ç”Ÿæˆå ±è¡¨å¤±æ•—', 'error');
    }
}

// Keyboard shortcut
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeEditModal();
});
</script>
</body>
</html>